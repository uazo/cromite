From: csagan5 <32685696+csagan5@users.noreply.github.com>
Date: Thu, 10 Oct 2019 23:30:16 +0200
Subject: Restore Search Ready Omnibox flag

Revert "Cleanup Search Ready Omnibox flag since it has launched"
This reverts commit ae458edcc8422d0815d0e82261e71fe10d7d6fc2.

Disable search-ready omnibox by default

License: GPL-3.0-only - https://spdx.org/licenses/GPL-3.0-only.html
---
 chrome/browser/flags/android/chrome_feature_list.cc |  1 +
 .../chrome/browser/flags/ChromeFeatureList.java     |  1 +
 .../DropdownItemViewInfoListBuilder.java            |  9 ++++++++-
 .../restore-Search-Ready-Omnibox-flag.inc           | 13 +++++++++++++
 .../restore-Search-Ready-Omnibox-flag.inc           |  3 +++
 .../restore-Search-Ready-Omnibox-flag.inc           |  1 +
 6 files changed, 27 insertions(+), 1 deletion(-)
 create mode 100644 cromite_flags/chrome/browser/about_flags_cc/restore-Search-Ready-Omnibox-flag.inc
 create mode 100644 cromite_flags/chrome/browser/flags/android/chrome_feature_list_cc/restore-Search-Ready-Omnibox-flag.inc
 create mode 100644 cromite_flags/chrome/browser/flags/android/chrome_feature_list_h/restore-Search-Ready-Omnibox-flag.inc

diff --git a/chrome/browser/flags/android/chrome_feature_list.cc b/chrome/browser/flags/android/chrome_feature_list.cc
--- a/chrome/browser/flags/android/chrome_feature_list.cc
+++ b/chrome/browser/flags/android/chrome_feature_list.cc
@@ -391,6 +391,7 @@ const base::Feature* const kFeaturesExposedToJava[] = {
     &kReadAloudIPHMenuButtonHighlightCCT,
     &kRecordSuppressionMetrics,
     &kReengagementNotification,
+    &kSearchReadyOmniboxFeature,
     &kRelatedSearchesAllLanguage,
     &kRelatedSearchesSwitch,
     &kReloadTabUiResourcesIfChanged,
diff --git a/chrome/browser/flags/android/java/src/org/chromium/chrome/browser/flags/ChromeFeatureList.java b/chrome/browser/flags/android/java/src/org/chromium/chrome/browser/flags/ChromeFeatureList.java
--- a/chrome/browser/flags/android/java/src/org/chromium/chrome/browser/flags/ChromeFeatureList.java
+++ b/chrome/browser/flags/android/java/src/org/chromium/chrome/browser/flags/ChromeFeatureList.java
@@ -485,6 +485,7 @@ public abstract class ChromeFeatureList {
     public static final String MITIGATE_LEGACY_SEARCH_ENGINE_PROMO_OVERLAP =
             "MitigateLegacySearchEnginePromoOverlap";
     public static final String MOST_VISITED_TILES_CUSTOMIZATION = "MostVisitedTilesCustomization";
+    public static final String SEARCH_READY_OMNIBOX = "SearchReadyOmnibox";
     public static final String MOST_VISITED_TILES_RESELECT = "MostVisitedTilesReselect";
     public static final String MULTI_INSTANCE_APPLICATION_STATUS_CLEANUP =
             "MultiInstanceApplicationStatusCleanup";
diff --git a/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/suggestions/DropdownItemViewInfoListBuilder.java b/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/suggestions/DropdownItemViewInfoListBuilder.java
--- a/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/suggestions/DropdownItemViewInfoListBuilder.java
+++ b/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/suggestions/DropdownItemViewInfoListBuilder.java
@@ -9,6 +9,7 @@ import android.text.TextUtils;
 
 import androidx.annotation.VisibleForTesting;
 
+import org.chromium.chrome.browser.flags.ChromeFeatureList;
 import org.chromium.build.annotations.Initializer;
 import org.chromium.build.annotations.NullMarked;
 import org.chromium.build.annotations.Nullable;
@@ -53,6 +54,7 @@ class DropdownItemViewInfoListBuilder {
     private Optional<OmniboxImageSupplier> mImageSupplier;
     private final BookmarkState mBookmarkState;
     private final Supplier<@ControlsPosition Integer> mToolbarPositionSupplier;
+    private EditUrlSuggestionProcessor mEditUrlSuggestionProcessor;
 
     DropdownItemViewInfoListBuilder(
             Supplier<@Nullable Tab> tabSupplier,
@@ -107,10 +109,12 @@ class DropdownItemViewInfoListBuilder {
 
         mGroupSeparatorProcessor = new GroupSeparatorProcessor(uiContext.context);
         mHeaderProcessor = new HeaderProcessor(uiContext.context);
-        registerSuggestionProcessor(new EditUrlSuggestionProcessor(uiContext));
+        mEditUrlSuggestionProcessor = new EditUrlSuggestionProcessor(uiContext);
         registerSuggestionProcessor(new AnswerSuggestionProcessor(uiContext));
         registerSuggestionProcessor(new ClipboardSuggestionProcessor(uiContext));
         registerSuggestionProcessor(new EntitySuggestionProcessor(uiContext));
+        registerSuggestionProcessor(mEditUrlSuggestionProcessor);
+
         registerSuggestionProcessor(new TailSuggestionProcessor(uiContext));
         registerSuggestionProcessor(new MostVisitedTilesProcessor(uiContext));
         if (OmniboxFeatures.sAndroidHubSearchTabGroups.isEnabled()) {
@@ -190,6 +194,9 @@ class DropdownItemViewInfoListBuilder {
         mHeaderProcessor.onNativeInitialized();
         mImageSupplier.ifPresent(s -> s.onNativeInitialized());
 
+        if (ChromeFeatureList.isEnabled(ChromeFeatureList.SEARCH_READY_OMNIBOX) == false) {
+            mPriorityOrderedSuggestionProcessors.remove(mEditUrlSuggestionProcessor);
+        }
         for (int index = 0; index < mPriorityOrderedSuggestionProcessors.size(); index++) {
             mPriorityOrderedSuggestionProcessors.get(index).onNativeInitialized();
         }
diff --git a/cromite_flags/chrome/browser/about_flags_cc/restore-Search-Ready-Omnibox-flag.inc b/cromite_flags/chrome/browser/about_flags_cc/restore-Search-Ready-Omnibox-flag.inc
new file mode 100644
--- /dev/null
+++ b/cromite_flags/chrome/browser/about_flags_cc/restore-Search-Ready-Omnibox-flag.inc
@@ -0,0 +1,13 @@
+#if BUILDFLAG(IS_ANDROID)
+
+#ifdef FLAG_SECTION
+
+    {"enable-search-ready-omnibox",
+     "Search Ready Omnibox",
+     "Clears the omnibox and adds a suggestion item to share, copy, or edit the "
+     "URL.", kOsAndroid,
+     FEATURE_VALUE_TYPE(chrome::android::kSearchReadyOmniboxFeature)},
+
+#endif
+
+#endif
diff --git a/cromite_flags/chrome/browser/flags/android/chrome_feature_list_cc/restore-Search-Ready-Omnibox-flag.inc b/cromite_flags/chrome/browser/flags/android/chrome_feature_list_cc/restore-Search-Ready-Omnibox-flag.inc
new file mode 100644
--- /dev/null
+++ b/cromite_flags/chrome/browser/flags/android/chrome_feature_list_cc/restore-Search-Ready-Omnibox-flag.inc
@@ -0,0 +1,3 @@
+CROMITE_FEATURE(kSearchReadyOmniboxFeature,
+               "SearchReadyOmnibox",
+               base::FEATURE_ENABLED_BY_DEFAULT);
diff --git a/cromite_flags/chrome/browser/flags/android/chrome_feature_list_h/restore-Search-Ready-Omnibox-flag.inc b/cromite_flags/chrome/browser/flags/android/chrome_feature_list_h/restore-Search-Ready-Omnibox-flag.inc
new file mode 100644
--- /dev/null
+++ b/cromite_flags/chrome/browser/flags/android/chrome_feature_list_h/restore-Search-Ready-Omnibox-flag.inc
@@ -0,0 +1 @@
+BASE_DECLARE_FEATURE(kSearchReadyOmniboxFeature);
--
