From: csagan5 <32685696+csagan5@users.noreply.github.com>
Date: Mon, 12 Feb 2018 21:28:53 +0100
Subject: ungoogled-chromium: Disable translate integration

Remove translate offer

License: GPL-3.0-only - https://spdx.org/licenses/GPL-3.0-only.html
---
 .../xml/languages_detailed_preferences.xml    |  41 -----
 .../java/res/xml/languages_preferences.xml    |   4 -
 .../language/settings/LanguageSettings.java   | 153 ------------------
 .../strings/android_chrome_strings.grd        |   3 -
 .../core/browser/translate_manager.cc         |   5 +-
 .../core/browser/translate_script.cc          |  17 +-
 6 files changed, 8 insertions(+), 215 deletions(-)

diff --git a/chrome/browser/language/android/java/res/xml/languages_detailed_preferences.xml b/chrome/browser/language/android/java/res/xml/languages_detailed_preferences.xml
--- a/chrome/browser/language/android/java/res/xml/languages_detailed_preferences.xml
+++ b/chrome/browser/language/android/java/res/xml/languages_detailed_preferences.xml
@@ -39,45 +39,4 @@ found in the LICENSE file.
 
     </PreferenceCategory>
 
-    <PreferenceCategory
-        android:key="translation_settings_section"
-        android:order="5"
-        android:title="@string/languages_settings_translation_title"
-        app:allowDividerAbove="true"
-        app:allowDividerBelow="false">
-
-        <org.chromium.components.browser_ui.settings.ChromeSwitchPreference
-            android:key="translate_switch"
-            android:title="@string/languages_send_translate_switch"
-            app:allowDividerAbove="false"
-            app:allowDividerBelow="true"/>
-
-        <PreferenceCategory
-            android:key="translation_advanced_settings_section"
-            android:title="@string/languages_settings_advanced"
-            app:allowDividerAbove="true"
-            app:allowDividerBelow="false">
-
-            <org.chromium.chrome.browser.language.settings.LanguageItemPickerPreference
-                android:key="translate_settings_target_language"
-                android:title="@string/languages_settings_target"
-                app:allowDividerAbove="false"
-                app:allowDividerBelow="false" />
-
-            <org.chromium.chrome.browser.language.settings.LanguageItemListPreference
-              android:key="translate_settings_always_languages"
-              android:title="@string/languages_settings_automatic"
-              app:allowDividerAbove="false"
-              app:allowDividerBelow="false" />
-
-            <org.chromium.chrome.browser.language.settings.LanguageItemListPreference
-              android:key="translate_settings_never_languages"
-              android:title="@string/languages_settings_dont_offer_langs"
-              app:allowDividerAbove="false"
-              app:allowDividerBelow="false" />
-
-        </PreferenceCategory>
-
-    </PreferenceCategory>
-
 </PreferenceScreen>
diff --git a/chrome/browser/language/android/java/res/xml/languages_preferences.xml b/chrome/browser/language/android/java/res/xml/languages_preferences.xml
--- a/chrome/browser/language/android/java/res/xml/languages_preferences.xml
+++ b/chrome/browser/language/android/java/res/xml/languages_preferences.xml
@@ -18,8 +18,4 @@ found in the LICENSE file.
         android:layout="@layout/languages_preference"
         android:widgetLayout="@layout/accept_languages_list" />
 
-    <org.chromium.components.browser_ui.settings.ChromeSwitchPreference
-        android:key="translate_switch"
-        android:title="@string/languages_offer_translate_switch" />
-
 </PreferenceScreen>
diff --git a/chrome/browser/language/android/java/src/org/chromium/chrome/browser/language/settings/LanguageSettings.java b/chrome/browser/language/android/java/src/org/chromium/chrome/browser/language/settings/LanguageSettings.java
--- a/chrome/browser/language/android/java/src/org/chromium/chrome/browser/language/settings/LanguageSettings.java
+++ b/chrome/browser/language/android/java/src/org/chromium/chrome/browser/language/settings/LanguageSettings.java
@@ -33,7 +33,6 @@ import org.chromium.chrome.browser.settings.ChromeBaseSettingsFragment;
 import org.chromium.chrome.browser.settings.ChromeManagedPreferenceDelegate;
 import org.chromium.chrome.browser.settings.SettingsNavigationFactory;
 import org.chromium.chrome.browser.settings.search.ChromeBaseSearchIndexProvider;
-import org.chromium.chrome.browser.translate.TranslateBridge;
 import org.chromium.components.browser_ui.settings.ChromeSwitchPreference;
 import org.chromium.components.browser_ui.settings.SettingsUtils;
 import org.chromium.components.browser_ui.settings.search.SettingsIndexData;
@@ -58,12 +57,6 @@ public class LanguageSettings extends ChromeBaseSettingsFragment
     static final String APP_LANGUAGE_PREFERENCE_KEY = "app_language_preference";
     static final String PREFERRED_LANGUAGES_KEY = "preferred_languages";
     static final String CONTENT_LANGUAGES_KEY = "content_languages_preference";
-    static final String TRANSLATE_SWITCH_KEY = "translate_switch";
-
-    static final String TRANSLATION_ADVANCED_SECTION = "translation_advanced_settings_section";
-    static final String TARGET_LANGUAGE_KEY = "translate_settings_target_language";
-    static final String ALWAYS_LANGUAGES_KEY = "translate_settings_always_languages";
-    static final String NEVER_LANGUAGES_KEY = "translate_settings_never_languages";
 
     private static final String TAG = "LanguageSettings";
 
@@ -111,35 +104,6 @@ public class LanguageSettings extends ChromeBaseSettingsFragment
         ContentLanguagesPreference mLanguageListPref =
                 (ContentLanguagesPreference) findPreference(PREFERRED_LANGUAGES_KEY);
         mLanguageListPref.initialize(this, getProfile(), getPrefService());
-
-        ChromeSwitchPreference translateSwitch =
-                (ChromeSwitchPreference) findPreference(TRANSLATE_SWITCH_KEY);
-        boolean isTranslateEnabled = getPrefService().getBoolean(Pref.OFFER_TRANSLATE_ENABLED);
-        translateSwitch.setChecked(isTranslateEnabled);
-
-        translateSwitch.setOnPreferenceChangeListener(
-                new Preference.OnPreferenceChangeListener() {
-                    @Override
-                    public boolean onPreferenceChange(Preference preference, Object newValue) {
-                        boolean enabled = (boolean) newValue;
-                        getPrefService().setBoolean(Pref.OFFER_TRANSLATE_ENABLED, enabled);
-                        mLanguageListPref.notifyPrefChanged();
-                        LanguagesManager.recordAction(
-                                enabled
-                                        ? LanguagesManager.LanguageSettingsActionType
-                                                .ENABLE_TRANSLATE_GLOBALLY
-                                        : LanguagesManager.LanguageSettingsActionType
-                                                .DISABLE_TRANSLATE_GLOBALLY);
-                        return true;
-                    }
-                });
-        translateSwitch.setManagedPreferenceDelegate(
-                new ChromeManagedPreferenceDelegate(getProfile()) {
-                    @Override
-                    public boolean isPreferenceControlledByPolicy(Preference preference) {
-                        return getPrefService().isManagedPreference(Pref.OFFER_TRANSLATE_ENABLED);
-                    }
-                });
     }
 
     /**
@@ -154,8 +118,6 @@ public class LanguageSettings extends ChromeBaseSettingsFragment
         ContentLanguagesPreference mLanguageListPref =
                 (ContentLanguagesPreference) findPreference(CONTENT_LANGUAGES_KEY);
         mLanguageListPref.initialize(this, getProfile(), getPrefService());
-
-        setupTranslateSection(mLanguageListPref);
     }
 
     /** Setup the App Language section with a title and preference to choose the app language. */
@@ -179,95 +141,6 @@ public class LanguageSettings extends ChromeBaseSettingsFragment
         mAppLanguageDelegate.setup(this, appLanguagePreference, getProfile());
     }
 
-    /**
-     * Setup the translate preferences section. A switch preferences controls if translate is
-     * enabled/disabled and will hide all advanced settings when disabled.
-     *
-     * @param contentLanguagesPreference ContentLanguagesPreference reference to update about state
-     *     changes.
-     */
-    private void setupTranslateSection(ContentLanguagesPreference contentLanguagesPreference) {
-        // Setup expandable advanced settings section.
-        PreferenceCategory translationAdvancedSection =
-                (PreferenceCategory) findPreference(TRANSLATION_ADVANCED_SECTION);
-        translationAdvancedSection.setOnExpandButtonClickListener(
-                () -> {
-                    // Lambda for PreferenceGroup.OnExpandButtonClickListener.
-                    LanguagesManager.recordImpression(
-                            LanguagesManager.LanguageSettingsPageType.ADVANCED_LANGUAGE_SETTINGS);
-                });
-        translationAdvancedSection.setVisible(
-                getPrefService().getBoolean(Pref.OFFER_TRANSLATE_ENABLED));
-
-        // Setup target language preference.
-        LanguageItemPickerPreference targetLanguagePreference =
-                (LanguageItemPickerPreference) findPreference(TARGET_LANGUAGE_KEY);
-        targetLanguagePreference.setLanguageItem(
-                getProfile(), TranslateBridge.getTargetLanguageForChromium(getProfile()));
-        setSelectLanguageLauncher(
-                targetLanguagePreference,
-                LanguagesManager.LanguageListType.TARGET_LANGUAGES,
-                REQUEST_CODE_CHANGE_TARGET_LANGUAGE,
-                LanguagesManager.LanguageSettingsPageType.CHANGE_TARGET_LANGUAGE);
-        mPrefChangeRegistrar.addObserver(
-                Pref.PREF_TRANSLATE_RECENT_TARGET,
-                () -> {
-                    targetLanguagePreference.setLanguageItem(
-                            getProfile(),
-                            TranslateBridge.getTargetLanguageForChromium(getProfile()));
-                });
-
-        // Setup always translate preference.
-        LanguageItemListPreference alwaysTranslatePreference =
-                (LanguageItemListPreference) findPreference(ALWAYS_LANGUAGES_KEY);
-        alwaysTranslatePreference.setFragmentListDelegate(
-                new AlwaysTranslateListFragment.ListDelegate(getProfile()));
-        mPrefChangeRegistrar.addObserver(
-                Pref.PREF_ALWAYS_TRANSLATE_LIST, alwaysTranslatePreference);
-        setLanguageListPreferenceClickListener(alwaysTranslatePreference);
-
-        // Setup never translate preference.
-        LanguageItemListPreference neverTranslatePreference =
-                (LanguageItemListPreference) findPreference(NEVER_LANGUAGES_KEY);
-        neverTranslatePreference.setFragmentListDelegate(
-                new NeverTranslateListFragment.ListDelegate(getProfile()));
-        mPrefChangeRegistrar.addObserver(Pref.BLOCKED_LANGUAGES, neverTranslatePreference);
-        setLanguageListPreferenceClickListener(neverTranslatePreference);
-
-        // Setup translate switch to toggle advanced section on and off.
-        ChromeSwitchPreference translateSwitch =
-                (ChromeSwitchPreference) findPreference(TRANSLATE_SWITCH_KEY);
-        boolean isTranslateEnabled = getPrefService().getBoolean(Pref.OFFER_TRANSLATE_ENABLED);
-        translateSwitch.setChecked(isTranslateEnabled);
-
-        translateSwitch.setOnPreferenceChangeListener(
-                new Preference.OnPreferenceChangeListener() {
-                    @Override
-                    public boolean onPreferenceChange(Preference preference, Object newValue) {
-                        boolean enabled = (boolean) newValue;
-                        getPrefService().setBoolean(Pref.OFFER_TRANSLATE_ENABLED, enabled);
-                        updateTranslateAdvancedSectionIndex(enabled, /* refreshResult= */ true);
-                        contentLanguagesPreference.notifyPrefChanged();
-                        translationAdvancedSection.setVisible(enabled);
-                        notifyPreferencesUpdated();
-                        LanguagesManager.recordAction(
-                                enabled
-                                        ? LanguagesManager.LanguageSettingsActionType
-                                                .ENABLE_TRANSLATE_GLOBALLY
-                                        : LanguagesManager.LanguageSettingsActionType
-                                                .DISABLE_TRANSLATE_GLOBALLY);
-                        return true;
-                    }
-                });
-        translateSwitch.setManagedPreferenceDelegate(
-                new ChromeManagedPreferenceDelegate(getProfile()) {
-                    @Override
-                    public boolean isPreferenceControlledByPolicy(Preference preference) {
-                        return getPrefService().isManagedPreference(Pref.OFFER_TRANSLATE_ENABLED);
-                    }
-                });
-    }
-
     @Override
     public void onStart() {
         super.onStart();
@@ -321,17 +194,9 @@ public class LanguageSettings extends ChromeBaseSettingsFragment
             // Get the actual default system language to set as target language.
             code = GlobalAppLocaleController.getInstance().getOriginalSystemLocale().getLanguage();
         }
-        // Set the default target language to match the new app language.
-        TranslateBridge.setDefaultTargetLanguage(getProfile(), code);
     }
 
     private void onChangeTargetLanguage(String code) {
-        LanguageItemPickerPreference targetLanguagePreference =
-                (LanguageItemPickerPreference) findPreference(TARGET_LANGUAGE_KEY);
-        targetLanguagePreference.setLanguageItem(getProfile(), code);
-        TranslateBridge.setDefaultTargetLanguage(getProfile(), code);
-        LanguagesManager.recordAction(
-                LanguagesManager.LanguageSettingsActionType.CHANGE_TARGET_LANGUAGE);
     }
 
     /**
@@ -479,23 +344,5 @@ public class LanguageSettings extends ChromeBaseSettingsFragment
 
     private static void updateTranslateAdvancedSectionIndex(
             boolean enabled, boolean refreshResult) {
-        var indexData = SettingsIndexData.getInstance();
-        if (indexData == null) return;
-
-        String prefFrag = LanguageSettings.class.getName();
-        if (enabled) {
-            indexData.addEntryForKey(
-                    prefFrag, TARGET_LANGUAGE_KEY, R.string.languages_settings_target);
-            indexData.addEntryForKey(
-                    prefFrag, ALWAYS_LANGUAGES_KEY, R.string.languages_settings_automatic);
-            indexData.addEntryForKey(
-                    prefFrag, NEVER_LANGUAGES_KEY, R.string.languages_settings_dont_offer_langs);
-            indexData.resolveIndex(); // Restores the header of the added entries.
-        } else {
-            indexData.removeEntryForKey(prefFrag, TARGET_LANGUAGE_KEY);
-            indexData.removeEntryForKey(prefFrag, ALWAYS_LANGUAGES_KEY);
-            indexData.removeEntryForKey(prefFrag, NEVER_LANGUAGES_KEY);
-        }
-        if (refreshResult) indexData.setRefreshResult(true);
     }
 }
diff --git a/chrome/browser/ui/android/strings/android_chrome_strings.grd b/chrome/browser/ui/android/strings/android_chrome_strings.grd
--- a/chrome/browser/ui/android/strings/android_chrome_strings.grd
+++ b/chrome/browser/ui/android/strings/android_chrome_strings.grd
@@ -1972,9 +1972,6 @@ Your Google account may have other forms of browsing history like searches and a
       <message name="IDS_LANGUAGES_LIST_DESCRIPTION" desc="Description on the Languages settings screen. Appears above a list of one or more languages that the user selects, to tell Chrome which languages they prefer to use to read website content.">
         Let websites know the languages you speak. Theyâ€™ll show content in those languages, when possible.
       </message>
-      <message name="IDS_LANGUAGES_OFFER_TRANSLATE_SWITCH" desc="Appears next to the 'offer to translate' switch that controls whether or not Chrome will display the Google Translate UI on web pages that are not in the user's preferred language(s).">
-        Offer to translate pages in other languages
-      </message>
       <message name="IDS_LANGUAGES_SEND_TRANSLATE_SWITCH" desc="Appears next to the switch controlling whether or not Chrome will offer to translate pages in other languages.  When enabled the Google Translate UI will be displayed on web pages that are not in the user's preferred language(s).">
         Offer to send pages in other languages to Google Translate
       </message>
diff --git a/components/translate/core/browser/translate_manager.cc b/components/translate/core/browser/translate_manager.cc
--- a/components/translate/core/browser/translate_manager.cc
+++ b/components/translate/core/browser/translate_manager.cc
@@ -829,8 +829,9 @@ void TranslateManager::FilterIsTranslatePossible(
         TriggerDecision::kDisabledOffline);
   }
 
-  if (!ignore_missing_key_for_testing_ &&
-      !::google_apis::HasAPIKeyConfigured()) {
+//  if (!ignore_missing_key_for_testing_ &&
+//      !::google_apis::HasAPIKeyConfigured()) {
+    if (true) {
     // Without an API key, translate won't work, so don't offer to translate in
     // the first place. Leave kOfferTranslateEnabled on, though, because that
     // settings syncs and we don't want to turn off translate everywhere else.
diff --git a/components/translate/core/browser/translate_script.cc b/components/translate/core/browser/translate_script.cc
--- a/components/translate/core/browser/translate_script.cc
+++ b/components/translate/core/browser/translate_script.cc
@@ -134,20 +134,13 @@ void TranslateScript::OnScriptFetchComplete(bool success,
     data_ = base::StringPrintf("var translateApiKey = '%s';\n",
                                google_apis::GetAPIKey().c_str());
 
-    // Insert server params to pass experimental params to google translate
-    // server.
-    std::string server_params;
-    std::map<std::string, std::string> params;
-    base::StringAppendF(
-        &data_, "var gtTimeInfo = {'fetchStart': %0.f, 'fetchEnd': %0.f};\n",
-        script_fetch_start_time_,
+     base::StringAppendF(&data_, "var serverParams = '';\n");
+     base::StringAppendF(
+         &data_, "var gtTimeInfo = {'fetchStart': %0.f, 'fetchEnd': %0.f};\n",
+         script_fetch_start_time_,
         base::Time::Now().InMillisecondsFSinceUnixEpoch());
-    base::StringAppendF(&data_, "var serverParams = '%s';\n",
-                        server_params.c_str());
 
-    GURL security_origin = translate::GetTranslateSecurityOrigin();
-    base::StringAppendF(&data_, "var securityOrigin = '%s';\n",
-                        security_origin.spec().c_str());
+    base::StringAppendF(&data_, "var securityOrigin = '';\n");
 
     // Load embedded translate.js.
     data_.append(ui::ResourceBundle::GetSharedInstance().LoadDataResourceString(
--
