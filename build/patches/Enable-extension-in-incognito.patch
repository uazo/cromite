From: uazo <uazo@users.noreply.github.com>
Date: Thu, 20 Nov 2025 12:53:28 +0000
Subject: Enable extensions in incognito

Full activation of incognito mode in experimental extension

License: GPL-3.0-only - https://spdx.org/licenses/GPL-3.0-only.html
---
 .../chrome/browser/ChromeTabbedActivity.java  | 40 +++++++-
 .../chrome/browser/app/ChromeActivity.java    | 24 ++++-
 .../customtabs/BaseCustomTabActivity.java     |  2 +-
 .../BaseCustomTabRootUiCoordinator.java       |  4 +-
 .../CustomTabIntentDataProvider.java          |  3 +
 .../tabbed_mode/TabbedRootUiCoordinator.java  |  3 +-
 .../browser/tabmodel/TabModelJniBridge.java   |  4 +-
 .../tabmodel/TabModelSelectorBase.java        |  7 ++
 .../browser/toolbar/ToolbarManager.java       |  4 +-
 .../chrome/browser/ui/RootUiCoordinator.java  |  6 +-
 .../developer_private_functions_shared.cc     |  4 +-
 .../browser/extensions/extension_tab_util.cc  |  2 +-
 .../tabmodel/IncognitoTabModelImpl.java       | 10 +-
 .../tabmodel/IncognitoTabModelObserver.java   |  2 +
 .../extensions/extension_actions_bridge.cc    | 12 +++
 .../extensions/extension_actions_bridge.h     |  1 +
 .../ui/extensions/ExtensionActionsBridge.java |  6 ++
 .../android/tab_model/tab_model_jni_bridge.cc |  4 +
 .../ExtensionActionListCoordinator.java       |  4 +-
 .../ExtensionActionListMediator.java          | 16 ++--
 .../ExtensionToolbarCoordinator.java          |  7 +-
 .../ExtensionToolbarCoordinatorImpl.java      |  5 +-
 .../ChromeAndroidTaskTrackerImpl.java         | 93 ++++++++++++++-----
 .../ChromeAndroidTaskTracker.java             |  6 +-
 24 files changed, 213 insertions(+), 56 deletions(-)

diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
@@ -109,6 +109,7 @@ import org.chromium.chrome.browser.compositor.overlays.strip.StripLayoutHelperMa
 import org.chromium.chrome.browser.compositor.overlays.strip.StripLayoutHelperManager.TabModelStartupInfo;
 import org.chromium.chrome.browser.cookies.CookiesFetcher;
 import org.chromium.chrome.browser.crypto.CipherFactory;
+import org.chromium.chrome.browser.customtabs.CustomTabActivity;
 import org.chromium.chrome.browser.data_sharing.DataSharingIntentUtils;
 import org.chromium.chrome.browser.data_sharing.DataSharingTabGroupUtils;
 import org.chromium.chrome.browser.data_sharing.DataSharingTabManager;
@@ -284,12 +285,14 @@ import org.chromium.chrome.browser.tasks.tab_management.TabSwitcherPaneBase;
 import org.chromium.chrome.browser.tasks.tab_management.TabUiUtils;
 import org.chromium.chrome.browser.tasks.tab_management.TabsSettings;
 import org.chromium.chrome.browser.tasks.tab_management.archived_tabs_auto_delete_promo.ArchivedTabsAutoDeletePromoManager;
+import org.chromium.chrome.browser.tabmodel.IncognitoTabModelObserver;
 import org.chromium.chrome.browser.toolbar.ToolbarIntentMetadata;
 import org.chromium.chrome.browser.toolbar.ToolbarManager;
 import org.chromium.chrome.browser.toolbar.extensions.ExtensionToolbarCoordinator;
 import org.chromium.chrome.browser.toolbar.top.ToolbarControlContainer;
 import org.chromium.chrome.browser.toolbar.top.tab_strip.StripVisibilityState;
 import org.chromium.chrome.browser.ui.AppLaunchDrawBlocker;
+import org.chromium.chrome.browser.ui.extensions.ExtensionActionsBridge;
 import org.chromium.chrome.browser.ui.IncognitoRestoreAppLaunchDrawBlockerFactory;
 import org.chromium.chrome.browser.ui.RootUiCoordinator;
 import org.chromium.chrome.browser.ui.appmenu.AppMenuPropertiesDelegate;
@@ -834,7 +837,36 @@ public class ChromeTabbedActivity extends ChromeActivity {
             mTabModelNotificationDotManager.initWithNative(mTabModelSelector);
             TabModel currentTabModel = mTabModelSelector.getCurrentModel();
             initializeChromeAndroidTask(
-                    BrowserWindowType.NORMAL, currentTabModel, mMultiInstanceManager);
+                    BrowserWindowType.NORMAL, mTabModelSelector.getModel(false), mMultiInstanceManager);
+
+            ProfileManager.addObserver(
+                new ProfileManager.Observer() {
+                    @Override
+                    public void onProfileAdded(Profile profile) {}
+
+                    @Override
+                    public void onProfileDestroyed(Profile profile) {
+                        if (!profile.isOffTheRecord()) return;
+                        ExtensionActionsBridge.get(profile)
+                            .closeBackgroundHosts();
+                    }
+                });
+
+            mTabModelSelector.addIncognitoTabModelObserver(
+                new IncognitoTabModelObserver() {
+                    @Override
+                    public void wasFirstTabCreated() {
+                        initializeChromeAndroidTask(BrowserWindowType.NORMAL,
+                            mTabModelSelector.getModel(true),
+                            mMultiInstanceManager);
+                    }
+
+                    @Override
+                    public void didDestroyed() {
+                        destroyIncognitoAndroidTask(
+                            mTabModelSelector.getModel(true));
+                    }
+                });
 
             // For saving non-incognito tab closures for Recent Tabs.
             boolean alwaysIncognito = AlwaysIncognitoLinkInterceptor.isAlwaysIncognito();
@@ -2937,7 +2969,7 @@ public class ChromeTabbedActivity extends ChromeActivity {
                 mLayoutStateProviderSupplier,
                 getBrowserControlsManager(),
                 getWindowAndroid(),
-                getChromeAndroidTaskSupplier(),
+                (tab) -> getChromeAndroidTask(tab),
                 getLifecycleDispatcher(),
                 getLayoutManagerSupplier(),
                 /* menuOrKeyboardActionController= */ this,
@@ -3877,6 +3909,10 @@ public class ChromeTabbedActivity extends ChromeActivity {
             }
             RecordUserAction.record("MobileMenuRecentTabs");
         } else if (id == R.id.extensions_menu_id) {
+            if (getCurrentTabModel().isIncognito()) {
+                CustomTabActivity.showInfoPage(this, UrlConstants.CHROME_EXTENSIONS_URL);
+                return true;
+            }
             LoadUrlParams params =
                     new LoadUrlParams(
                             UrlConstants.CHROME_EXTENSIONS_URL, PageTransition.AUTO_TOPLEVEL);
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
@@ -448,7 +448,7 @@ public abstract class ChromeActivity extends AsyncInitializationActivity
 
     private @Nullable TabStateThemeResourceProvider mThemeResourceProvider;
 
-    private final OneshotSupplierImpl<ChromeAndroidTask> mChromeAndroidTaskSupplier =
+    private final OneshotSupplierImpl<ChromeAndroidTask> mChromeAndroidTaskSupplierInternal =
             new OneshotSupplierImpl<>();
 
     protected ChromeActivity() {
@@ -1099,13 +1099,29 @@ public abstract class ChromeActivity extends AsyncInitializationActivity
             }
 
             // 4. Make the ChromeAndroidTask available via OneshotSupplier.
-            mChromeAndroidTaskSupplier.set(chromeAndroidTask);
+            if (!currentTabModel.isIncognito())
+                mChromeAndroidTaskSupplierInternal.set(chromeAndroidTask);
+
+            onTopResumedActivityChangedWithNative(/* isTopResumedActivity= */ true);
         }
     }
 
     /** Returns an {@link OneshotSupplier} for {@link ChromeAndroidTask}. */
-    protected final OneshotSupplier<ChromeAndroidTask> getChromeAndroidTaskSupplier() {
-        return mChromeAndroidTaskSupplier;
+    protected final ChromeAndroidTask getChromeAndroidTask(Tab tab) {
+        TabModelSelector modelSelector = getTabModelSelector();
+        TabModel tabModel = modelSelector.getModelForTabId(tab.getId());
+        return ChromeAndroidTaskTrackerFactory.getInstance().get(
+            mChromeAndroidTaskSupplierInternal.get().getId(),
+            tabModel);
+    }
+
+    protected final void destroyIncognitoAndroidTask(TabModel tabModel) {
+        ChromeAndroidTask incognitoTask =
+            ChromeAndroidTaskTrackerFactory.getInstance().get(
+                mChromeAndroidTaskSupplierInternal.get().getId(),
+                tabModel);
+        ChromeAndroidTaskTrackerFactory.getInstance()
+            .onActivityWindowAndroidDestroy(incognitoTask);
     }
 
     @Override
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabActivity.java
@@ -364,7 +364,7 @@ public abstract class BaseCustomTabActivity extends ChromeActivity {
                         getTabModelSelectorSupplier(),
                         getBrowserControlsManager(),
                         getWindowAndroid(),
-                        getChromeAndroidTaskSupplier(),
+                        (tab) -> getChromeAndroidTask(tab),
                         getLifecycleDispatcher(),
                         getLayoutManagerSupplier(),
                         /* menuOrKeyboardActionController= */ this,
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabRootUiCoordinator.java b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabRootUiCoordinator.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabRootUiCoordinator.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabRootUiCoordinator.java
@@ -88,6 +88,7 @@ import org.chromium.chrome.browser.tab.EmptyTabObserver;
 import org.chromium.chrome.browser.tab.RequestDesktopUtils;
 import org.chromium.chrome.browser.tab.Tab;
 import org.chromium.chrome.browser.tab_ui.TabContentManager;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.TabCreatorManager;
 import org.chromium.chrome.browser.tabmodel.TabModelSelector;
 import org.chromium.chrome.browser.toolbar.adaptive.AdaptiveToolbarBehavior;
@@ -120,6 +121,7 @@ import org.chromium.ui.modaldialog.ModalDialogManager;
 
 import java.util.function.BooleanSupplier;
 import java.util.function.Supplier;
+import java.util.function.Function;
 
 /** A {@link RootUiCoordinator} variant that controls UI for {@link BaseCustomTabActivity}. */
 public class BaseCustomTabRootUiCoordinator extends RootUiCoordinator {
@@ -203,7 +205,7 @@ public class BaseCustomTabRootUiCoordinator extends RootUiCoordinator {
             @NonNull ObservableSupplier<TabModelSelector> tabModelSelectorSupplier,
             @NonNull BrowserControlsManager browserControlsManager,
             @NonNull ActivityWindowAndroid windowAndroid,
-            @NonNull OneshotSupplier<ChromeAndroidTask> chromeAndroidTaskSupplier,
+            @NonNull Function<Tab, ChromeAndroidTask> chromeAndroidTaskSupplier,
             @NonNull ActivityLifecycleDispatcher activityLifecycleDispatcher,
             @NonNull ObservableSupplier<LayoutManagerImpl> layoutManagerSupplier,
             @NonNull MenuOrKeyboardActionController menuOrKeyboardActionController,
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabIntentDataProvider.java b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabIntentDataProvider.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabIntentDataProvider.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabIntentDataProvider.java
@@ -340,6 +340,7 @@ public class CustomTabIntentDataProvider extends BrowserServicesIntentDataProvid
 
     private final boolean mEnableUrlBarHiding;
     private boolean mInteractWithBackground;
+    private boolean mIsExtension = false;
     private List<CustomButtonParams> mCustomButtonParams;
     private @Nullable Drawable mCloseButtonIcon;
     private final boolean mIsCloseButtonEnabled;
@@ -717,6 +718,7 @@ public class CustomTabIntentDataProvider extends BrowserServicesIntentDataProvid
         mSideSheetRoundedCornersPosition =
                 getActivitySideSheetRoundedCornersPositionFromIntent(intent);
 
+        mIsExtension = getUrlToLoad().startsWith(UrlConstants.CHROME_EXTENSIONS_URL);
         logCustomTabFeatures(intent, colorScheme);
         String packageName = getClientPackageNameFromSessionOrCallingActivity(mIntent, mSession);
         RecordHistogram.recordBooleanHistogram(
@@ -1333,6 +1335,7 @@ public class CustomTabIntentDataProvider extends BrowserServicesIntentDataProvid
 
     @Override
     public @CustomTabProfileType int getCustomTabMode() {
+        if (mIsExtension) return CustomTabProfileType.REGULAR;
         return AlwaysIncognitoLinkInterceptor.isAlwaysIncognito()
                 ? CustomTabProfileType.INCOGNITO
                 : (ChromeFeatureList.sMayLaunchurlUsesSeparateStoragePartition.isEnabled()
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedRootUiCoordinator.java b/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedRootUiCoordinator.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedRootUiCoordinator.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedRootUiCoordinator.java
@@ -175,6 +175,7 @@ import org.chromium.chrome.browser.toolbar.adaptive.AdaptiveToolbarBehavior;
 import org.chromium.chrome.browser.ui.RootUiCoordinator;
 import org.chromium.chrome.browser.ui.appmenu.AppMenuBlocker;
 import org.chromium.chrome.browser.ui.appmenu.AppMenuDelegate;
+import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask;
 import org.chromium.chrome.browser.ui.default_browser_promo.DefaultBrowserPromoUtils;
 import org.chromium.chrome.browser.ui.desktop_windowing.AppHeaderCoordinator;
 import org.chromium.chrome.browser.ui.desktop_windowing.AppHeaderUtils;
@@ -411,7 +412,7 @@ public class TabbedRootUiCoordinator extends RootUiCoordinator {
             @NonNull OneshotSupplier<LayoutStateProvider> layoutStateProviderOneshotSupplier,
             @NonNull BrowserControlsManager browserControlsManager,
             @NonNull ActivityWindowAndroid windowAndroid,
-            @NonNull OneshotSupplier chromeAndroidTaskSupplier,
+            @NonNull Function<Tab, ChromeAndroidTask> chromeAndroidTaskSupplier,
             @NonNull ActivityLifecycleDispatcher activityLifecycleDispatcher,
             @NonNull ObservableSupplier<LayoutManagerImpl> layoutManagerSupplier,
             @NonNull MenuOrKeyboardActionController menuOrKeyboardActionController,
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelJniBridge.java b/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelJniBridge.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelJniBridge.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelJniBridge.java
@@ -129,10 +129,10 @@ public abstract class TabModelJniBridge implements TabModelInternal {
     @Override
     public void associateWithBrowserWindow(long nativeAndroidBrowserWindow) {
         // Ensure this isn't set multiple times.
-        assert mNativeAndroidBrowserWindow == 0;
+        if (nativeAndroidBrowserWindow != 0) assert mNativeAndroidBrowserWindow == 0;
         mNativeAndroidBrowserWindow = nativeAndroidBrowserWindow;
 
-        assert nativeAndroidBrowserWindow != 0;
+        // assert nativeAndroidBrowserWindow != 0;
         TabModelJniBridgeJni.get()
                 .associateWithBrowserWindow(mNativeTabModelJniBridge, nativeAndroidBrowserWindow);
     }
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelSelectorBase.java b/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelSelectorBase.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelSelectorBase.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelSelectorBase.java
@@ -481,6 +481,13 @@ public abstract class TabModelSelectorBase
         }
     }
 
+    @Override
+    public void didDestroyed() {
+        for (IncognitoTabModelObserver observer : mIncognitoObservers) {
+            observer.didDestroyed();
+        }
+    }
+
     @Override
     public void didBecomeEmpty() {
         for (IncognitoTabModelObserver observer : mIncognitoObservers) {
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/toolbar/ToolbarManager.java b/chrome/android/java/src/org/chromium/chrome/browser/toolbar/ToolbarManager.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/toolbar/ToolbarManager.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/toolbar/ToolbarManager.java
@@ -137,6 +137,7 @@ import org.chromium.chrome.browser.tab.TabObscuringHandler;
 import org.chromium.chrome.browser.tab.TabSelectionType;
 import org.chromium.chrome.browser.tab_ui.TabContentManager;
 import org.chromium.chrome.browser.tab_ui.TabModelDotInfo;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.IncognitoStateProvider;
 import org.chromium.chrome.browser.tabmodel.TabCreatorManager;
 import org.chromium.chrome.browser.tabmodel.TabModel;
@@ -232,6 +233,7 @@ import org.chromium.url.GURL;
 
 import java.util.List;
 import java.util.function.Supplier;
+import java.util.function.Function;
 
 import org.chromium.chrome.browser.flags.ChromeFeatureList;
 import android.view.Gravity;
@@ -802,7 +804,7 @@ public class ToolbarManager
             ObservableSupplier<Boolean> omniboxFocusStateSupplier,
             OneshotSupplier<Boolean> promoShownOneshotSupplier,
             WindowAndroid windowAndroid,
-            OneshotSupplier<ChromeAndroidTask> chromeAndroidTaskSupplier,
+            Function<Tab, ChromeAndroidTask> chromeAndroidTaskSupplier,
             Supplier<Boolean> isInOverviewModeSupplier,
             Supplier<ModalDialogManager> modalDialogManagerSupplier,
             StatusBarColorController statusBarColorController,
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ui/RootUiCoordinator.java b/chrome/android/java/src/org/chromium/chrome/browser/ui/RootUiCoordinator.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/ui/RootUiCoordinator.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ui/RootUiCoordinator.java
@@ -145,6 +145,7 @@ import org.chromium.chrome.browser.tab.TabSelectionType;
 import org.chromium.chrome.browser.tab_ui.RecyclerViewPosition;
 import org.chromium.chrome.browser.tab_ui.TabContentManager;
 import org.chromium.chrome.browser.tab_ui.TabSwitcher;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.TabCreator;
 import org.chromium.chrome.browser.tabmodel.TabCreatorManager;
 import org.chromium.chrome.browser.tabmodel.TabModel;
@@ -230,6 +231,7 @@ import org.chromium.url.GURL;
 import java.lang.ref.WeakReference;
 import java.util.function.BooleanSupplier;
 import java.util.function.Supplier;
+import java.util.function.Function;
 
 /**
  * The root UI coordinator. This class will eventually be responsible for inflating and managing
@@ -263,7 +265,7 @@ public class RootUiCoordinator
     protected @Nullable AppMenuCoordinator mAppMenuCoordinator;
     private final MenuOrKeyboardActionController mMenuOrKeyboardActionController;
     protected final ActivityWindowAndroid mWindowAndroid;
-    private final OneshotSupplier<ChromeAndroidTask> mChromeAndroidTaskSupplier;
+    private final Function<Tab, ChromeAndroidTask> mChromeAndroidTaskSupplier;
 
     protected final ActivityTabProvider mActivityTabProvider;
     protected ObservableSupplier<ShareDelegate> mShareDelegateSupplier;
@@ -449,7 +451,7 @@ public class RootUiCoordinator
             @NonNull OneshotSupplier<LayoutStateProvider> layoutStateProviderOneshotSupplier,
             @NonNull BrowserControlsManager browserControlsManager,
             @NonNull ActivityWindowAndroid windowAndroid,
-            @NonNull OneshotSupplier<ChromeAndroidTask> chromeAndroidTaskSupplier,
+            @NonNull Function<Tab, ChromeAndroidTask> chromeAndroidTaskSupplier,
             @NonNull ActivityLifecycleDispatcher activityLifecycleDispatcher,
             @NonNull ObservableSupplier<LayoutManagerImpl> layoutManagerSupplier,
             @NonNull MenuOrKeyboardActionController menuOrKeyboardActionController,
diff --git a/chrome/browser/extensions/api/developer_private/developer_private_functions_shared.cc b/chrome/browser/extensions/api/developer_private/developer_private_functions_shared.cc
--- a/chrome/browser/extensions/api/developer_private/developer_private_functions_shared.cc
+++ b/chrome/browser/extensions/api/developer_private/developer_private_functions_shared.cc
@@ -1676,8 +1676,8 @@ DeveloperPrivateDismissSafetyHubExtensionsMenuNotificationFunction::Run() {
   }
 
   Profile* profile = Profile::FromBrowserContext(browser_context());
-  SafetyHubMenuNotificationServiceFactory::GetForProfile(profile)
-      ->DismissActiveNotificationOfModule(
+  if (auto* menu_notification_service_factory = SafetyHubMenuNotificationServiceFactory::GetForProfile(profile))
+      menu_notification_service_factory->DismissActiveNotificationOfModule(
           safety_hub::SafetyHubModuleType::EXTENSIONS);
   return RespondNow(NoArguments());
 }
diff --git a/chrome/browser/extensions/extension_tab_util.cc b/chrome/browser/extensions/extension_tab_util.cc
--- a/chrome/browser/extensions/extension_tab_util.cc
+++ b/chrome/browser/extensions/extension_tab_util.cc
@@ -1426,7 +1426,7 @@ bool ExtensionTabUtil::OpenOptionsPageFromWebContents(
   if (!url) {
     return false;
   }
-  const bool open_in_tab = ShouldOpenInTab(extension);
+  const bool open_in_tab = false; //ShouldOpenInTab(extension);
 // Opens the url as instructed by `open_in_tab`. On android we take a different
 // path because the `Browser` object is not available.
 // TODO(crbug.com/441209530): Unify the path on android after browser
diff --git a/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelImpl.java b/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelImpl.java
--- a/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelImpl.java
+++ b/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelImpl.java
@@ -140,8 +140,12 @@ class IncognitoTabModelImpl implements IncognitoTabModelInternal {
             return;
         }
 
+        // Disassociate
+        mDelegateModel.associateWithBrowserWindow(/*nativeAndroidBrowserWindow=*/ 0);
+        mNativeAndroidBrowserWindow = 0;
+
         for (IncognitoTabModelObserver observer : mIncognitoObservers) {
-            observer.didBecomeEmpty();
+            observer.didDestroyed();
         }
 
         mDelegateModel
@@ -152,6 +156,10 @@ class IncognitoTabModelImpl implements IncognitoTabModelInternal {
         mCurrentTabSupplier.set(null);
         mTabCountSupplier.set(0);
 
+        for (IncognitoTabModelObserver observer : mIncognitoObservers) {
+            observer.didBecomeEmpty();
+        }
+
         mDelegateModel = EmptyTabModel.getInstance(true);
         for (Callback<TabModelInternal> delegateModelObserver : mDelegateModelObservers) {
             delegateModelObserver.onResult(mDelegateModel);
diff --git a/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelObserver.java b/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelObserver.java
--- a/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelObserver.java
+++ b/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelObserver.java
@@ -30,4 +30,6 @@ public interface IncognitoTabModelObserver {
 
     /** Called when the last tab of the {@link IncognitoTabModel} is closed. */
     default void didBecomeEmpty() {}
+
+    default void didDestroyed() {}
 }
diff --git a/chrome/browser/ui/android/extensions/extension_actions_bridge.cc b/chrome/browser/ui/android/extensions/extension_actions_bridge.cc
--- a/chrome/browser/ui/android/extensions/extension_actions_bridge.cc
+++ b/chrome/browser/ui/android/extensions/extension_actions_bridge.cc
@@ -19,6 +19,8 @@
 #include "extensions/browser/extension_action.h"
 #include "extensions/browser/extension_action_manager.h"
 #include "extensions/browser/extension_registry.h"
+#include "extensions/browser/process_manager.h"
+#include "extensions/browser/process_manager_factory.h"
 #include "ui/color/color_provider_manager.h"
 #include "ui/events/android/key_event_android.h"
 #include "ui/events/event.h"
@@ -232,6 +234,16 @@ void ExtensionActionsBridge::ClearExtensionData(JNIEnv* env) {
         install_directory, install_updacked_directory));
 }
 
+void ExtensionActionsBridge::CloseBackgroundHosts(JNIEnv* env) {
+  extensions::ProcessManager* manager =
+          extensions::ProcessManagerFactory::GetForBrowserContextIfExists(profile_);
+  if (manager) {
+    manager->CloseBackgroundHosts();
+    ProcessManager::Get(profile_->GetOriginalProfile())
+            ->MaybeCreateStartupBackgroundHosts();
+  }
+}
+
 jni_zero::ScopedJavaLocalRef<jobject>
 ExtensionActionsBridge::HandleKeyDownEvent(
     JNIEnv* env,
diff --git a/chrome/browser/ui/android/extensions/extension_actions_bridge.h b/chrome/browser/ui/android/extensions/extension_actions_bridge.h
--- a/chrome/browser/ui/android/extensions/extension_actions_bridge.h
+++ b/chrome/browser/ui/android/extensions/extension_actions_bridge.h
@@ -55,6 +55,7 @@ class ExtensionActionsBridge : public ToolbarActionsModel::Observer,
       content::WebContents* web_contents);
   bool ExtensionsEnabled(JNIEnv* env);
   void ClearExtensionData(JNIEnv* env);
+  void CloseBackgroundHosts(JNIEnv* env);
   jni_zero::ScopedJavaLocalRef<jobject> HandleKeyDownEvent(
       JNIEnv* env,
       const ui::KeyEventAndroid& key_event);
diff --git a/chrome/browser/ui/android/extensions/java/src/org/chromium/chrome/browser/ui/extensions/ExtensionActionsBridge.java b/chrome/browser/ui/android/extensions/java/src/org/chromium/chrome/browser/ui/extensions/ExtensionActionsBridge.java
--- a/chrome/browser/ui/android/extensions/java/src/org/chromium/chrome/browser/ui/extensions/ExtensionActionsBridge.java
+++ b/chrome/browser/ui/android/extensions/java/src/org/chromium/chrome/browser/ui/extensions/ExtensionActionsBridge.java
@@ -244,6 +244,10 @@ public class ExtensionActionsBridge {
         ExtensionActionsBridgeJni.get().clearExtensionData(mNativeExtensionActionsBridge);
     }
 
+    public void closeBackgroundHosts() {
+        ExtensionActionsBridgeJni.get().closeBackgroundHosts(mNativeExtensionActionsBridge);
+    }
+
     @NativeMethods
     public interface Natives {
         ExtensionActionsBridge get(@JniType("Profile*") Profile profile);
@@ -278,6 +282,8 @@ public class ExtensionActionsBridge {
 
         void clearExtensionData(long nativeExtensionActionsBridge);
 
+        void closeBackgroundHosts(long nativeExtensionActionsBridge);
+
         HandleKeyEventResult handleKeyDownEvent(
                 long nativeExtensionActionsBridge,
                 @JniType("ui::KeyEventAndroid") KeyEvent keyEvent);
diff --git a/chrome/browser/ui/android/tab_model/tab_model_jni_bridge.cc b/chrome/browser/ui/android/tab_model/tab_model_jni_bridge.cc
--- a/chrome/browser/ui/android/tab_model/tab_model_jni_bridge.cc
+++ b/chrome/browser/ui/android/tab_model/tab_model_jni_bridge.cc
@@ -116,6 +116,10 @@ void TabModelJniBridge::AssociateWithBrowserWindow(
 // BrowserWindowInterface is available on desktop Android, but not other Android
 // builds. For non-desktop Android, this function should be a no-op.
 #if BUILDFLAG(IS_DESKTOP_ANDROID_CROMITE)
+  if (native_android_browser_window == 0) {
+    scoped_unowned_user_data_.reset();
+    return;
+  }
   BrowserWindowInterface* android_browser_window =
       reinterpret_cast<BrowserWindowInterface*>(native_android_browser_window);
   CHECK(android_browser_window != nullptr);
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListCoordinator.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListCoordinator.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListCoordinator.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListCoordinator.java
@@ -23,6 +23,8 @@ import org.chromium.ui.listmenu.ListMenuButton;
 import org.chromium.ui.modelutil.MVCListAdapter.ModelList;
 import org.chromium.ui.modelutil.ViewGroupAdapter;
 
+import java.util.function.Function;
+
 /**
  * Root component for the extension action buttons. Exposes public API for external consumers to
  * interact with the buttons and affect their states.
@@ -39,7 +41,7 @@ public class ExtensionActionListCoordinator implements Destroyable {
             Context context,
             ExtensionActionListContainer container,
             WindowAndroid windowAndroid,
-            OneshotSupplier<ChromeAndroidTask> taskSupplier,
+            Function<Tab, ChromeAndroidTask> taskSupplier,
             ObservableSupplier<Profile> profileSupplier,
             ObservableSupplier<Tab> currentTabSupplier) {
         mContainer = container;
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListMediator.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListMediator.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListMediator.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListMediator.java
@@ -33,6 +33,8 @@ import org.chromium.ui.modelutil.MVCListAdapter.ListItem;
 import org.chromium.ui.modelutil.MVCListAdapter.ModelList;
 import org.chromium.ui.modelutil.PropertyModel;
 
+import java.util.function.Function;
+
 @NullMarked
 class ExtensionActionListMediator implements Destroyable {
     private static final String TAG = "EALMediator";
@@ -40,7 +42,7 @@ class ExtensionActionListMediator implements Destroyable {
     private final Context mContext;
     private final WindowAndroid mWindowAndroid;
     private final ModelList mModels;
-    private final OneshotSupplier<ChromeAndroidTask> mTaskSupplier;
+    private final Function<Tab, ChromeAndroidTask> mTaskSupplier;
     private final ExtensionActionsUpdateHelper mExtensionActionsUpdateHelper;
 
     private final ActionsUpdateDelegate mActionsUpdateDelegate = new ActionsUpdateDelegate();
@@ -53,7 +55,7 @@ class ExtensionActionListMediator implements Destroyable {
             Context context,
             WindowAndroid windowAndroid,
             ModelList models,
-            OneshotSupplier<ChromeAndroidTask> taskSupplier,
+            Function<Tab, ChromeAndroidTask> taskSupplier,
             ObservableSupplier<Profile> profileSupplier,
             ObservableSupplier<Tab> currentTabSupplier) {
         mContext = context;
@@ -108,17 +110,17 @@ class ExtensionActionListMediator implements Destroyable {
         // button while its popup is open.
         closePopup();
 
-        ChromeAndroidTask task = mTaskSupplier.get();
-        if (task == null) {
-            return;
-        }
-
         Tab currentTab = mExtensionActionsUpdateHelper.getCurrentTab();
         if (currentTab == null) {
             return;
         }
         int tabId = currentTab.getId();
 
+        ChromeAndroidTask task = mTaskSupplier.apply(currentTab);
+        if (task == null) {
+            return;
+        }
+
         ExtensionActionPopupContents contents =
                 ExtensionActionPopupContents.create(task, actionId, tabId);
         assert mCurrentPopup == null;
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinator.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinator.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinator.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinator.java
@@ -17,11 +17,14 @@ import org.chromium.build.annotations.NullMarked;
 import org.chromium.build.annotations.Nullable;
 import org.chromium.chrome.browser.profiles.Profile;
 import org.chromium.chrome.browser.tab.Tab;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.TabCreator;
 import org.chromium.chrome.browser.theme.ThemeColorProvider;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask;
 import org.chromium.ui.base.WindowAndroid;
 
+import java.util.function.Function;
+
 /**
  * The coordinator of the extension-related toolbar UI.
  *
@@ -42,7 +45,7 @@ public interface ExtensionToolbarCoordinator extends Destroyable {
             Context context,
             ViewStub extensionToolbarStub,
             WindowAndroid windowAndroid,
-            OneshotSupplier<ChromeAndroidTask> taskSupplier,
+            Function<Tab, ChromeAndroidTask> taskSupplier,
             ObservableSupplier<Profile> profileSupplier,
             ObservableSupplier<Tab> currentTabSupplier,
             TabCreator tabCreator,
@@ -75,7 +78,7 @@ public interface ExtensionToolbarCoordinator extends Destroyable {
             Context context,
             ViewStub extensionToolbarStub,
             WindowAndroid windowAndroid,
-            OneshotSupplier<ChromeAndroidTask> taskSupplier,
+            Function<Tab, ChromeAndroidTask> taskSupplier,
             ObservableSupplier<Profile> profileSupplier,
             ObservableSupplier<Tab> currentTabSupplier,
             TabCreator tabCreator,
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinatorImpl.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinatorImpl.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinatorImpl.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinatorImpl.java
@@ -19,6 +19,7 @@ import org.chromium.build.annotations.Nullable;
 import org.chromium.build.annotations.ServiceImpl;
 import org.chromium.chrome.browser.profiles.Profile;
 import org.chromium.chrome.browser.tab.Tab;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.TabCreator;
 import org.chromium.chrome.browser.theme.ThemeColorProvider;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask;
@@ -27,6 +28,8 @@ import org.chromium.chrome.browser.ui.extensions.ExtensionUi;
 import org.chromium.chrome.browser.ui.extensions.R;
 import org.chromium.ui.base.WindowAndroid;
 
+import java.util.function.Function;
+
 /** The implementation of {@link ExtensionToolbarCoordinator}. */
 @NullMarked
 @ServiceImpl(ExtensionToolbarCoordinator.class)
@@ -46,7 +49,7 @@ public class ExtensionToolbarCoordinatorImpl implements ExtensionToolbarCoordina
             Context context,
             ViewStub extensionToolbarStub,
             WindowAndroid windowAndroid,
-            OneshotSupplier<ChromeAndroidTask> taskSupplier,
+            Function<Tab, ChromeAndroidTask> taskSupplier,
             ObservableSupplier<Profile> profileSupplier,
             ObservableSupplier<Tab> currentTabSupplier,
             TabCreator tabCreator,
diff --git a/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerImpl.java b/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerImpl.java
--- a/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerImpl.java
+++ b/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerImpl.java
@@ -33,6 +33,30 @@ import java.util.Map;
 @NullMarked
 final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
 
+    private static class Key {
+        public final Integer mTaskId;
+        public final TabModel mTabModel;
+
+        public Key(Integer taskId, TabModel tabModel) {
+            mTaskId = taskId;
+            mTabModel = tabModel;
+        }
+
+        @Override
+        public boolean equals(Object obj) {
+            assert obj instanceof Key : "Wrong key.";
+
+            Key ref = (Key) obj;
+            return this.mTaskId.equals(ref.mTaskId)
+                   && this.mTabModel.equals(ref.mTabModel);
+        }
+
+        @Override
+        public int hashCode() {
+            return mTaskId.hashCode() ^ mTabModel.hashCode();
+        }
+    }
+
     private static @Nullable ChromeAndroidTaskTrackerImpl sInstance;
 
     /**
@@ -40,7 +64,7 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
      * ChromeAndroidTask}'s ID when it is alive, and is different from its ID in the pending state.
      */
     @GuardedBy("mTasksLock")
-    private final Map<Integer, ChromeAndroidTask> mTasks = new ArrayMap<>();
+    private final Map<Key, ChromeAndroidTask> mTasksCromite = new ArrayMap<>();
 
     /**
      * Maps pending {@link ChromeAndroidTask} IDs to their instances. This reflects the {@link
@@ -74,7 +98,8 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
         int taskId = getTaskId(activityWindowAndroid);
 
         synchronized (mTasksLock) {
-            var existingTask = mTasks.get(taskId);
+            var key = new Key(taskId, tabModel);
+            var existingTask = mTasksCromite.get(key);
             if (existingTask != null) {
                 assert existingTask.getBrowserWindowType() == browserWindowType
                         : "The browser window type of an existing task can't be changed.";
@@ -88,7 +113,7 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
                 assert pendingTask != null : "Invalid pendingId provided.";
                 pendingTask.setActivityWindowAndroid(
                         activityWindowAndroid, tabModel, multiInstanceManager);
-                mTasks.put(taskId, pendingTask);
+                mTasksCromite.put(key, pendingTask);
                 return pendingTask;
             }
 
@@ -98,7 +123,7 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
                             activityWindowAndroid,
                             tabModel,
                             multiInstanceManager);
-            mTasks.put(taskId, newTask);
+            mTasksCromite.put(key, newTask);
             mObservers.forEach((observer) -> observer.onTaskAdded(newTask));
             return newTask;
         }
@@ -125,29 +150,30 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
 
     @Override
     @Nullable
-    public ChromeAndroidTask get(int taskId) {
+    public ChromeAndroidTask get(int taskId, TabModel tabModel) {
         synchronized (mTasksLock) {
-            return mTasks.get(taskId);
+            var key = new Key(taskId, tabModel);
+            return mTasksCromite.get(key);
         }
     }
 
-    @Override
-    public void remove(int taskId) {
-        synchronized (mTasksLock) {
-            removeInternalLocked(taskId);
-        }
-    }
+    // @Override
+    // public void remove(int taskId) {
+    //     synchronized (mTasksLock) {
+    //         removeInternalLocked(taskId);
+    //     }
+    // }
 
     @Override
     public void onActivityWindowAndroidDestroy(ActivityWindowAndroid activityWindowAndroid) {
         synchronized (mTasksLock) {
-            int taskId = getTaskId(activityWindowAndroid);
-            var task = mTasks.get(taskId);
+          int taskId = getTaskId(activityWindowAndroid);
 
-            if (task == null) {
-                return;
-            }
+          for (Key key : mTasksCromite.keySet()) {
+            if (key == null) continue;
+            if (key.mTaskId != taskId) continue;
 
+            var task = mTasksCromite.get(key);
             // If the ActivityWindowAndroid that's passed in isn't the ActivityWindowAndroid held by
             // this ChromeAndroidTask, don't do anything.
             //
@@ -166,6 +192,17 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
             // the right time to clear and destroy the ActivityWindowAndroid held by the
             // ChromeAndroidTask.
             if (task.getActivityWindowAndroid() != activityWindowAndroid) {
+                continue;
+            }
+            onActivityWindowAndroidDestroy(task);
+          }
+        }
+    }
+
+    @Override
+    public void onActivityWindowAndroidDestroy(ChromeAndroidTask task) {
+        synchronized (mTasksLock) {
+            if (task == null) {
                 return;
             }
 
@@ -181,7 +218,7 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
             //
             // In the future, we can register a Task listener when a ChromeAndroidTask is created,
             // then destroy it when notified of the Task removal.
-            removeInternalLocked(taskId);
+            removeInternalLocked(task);
         }
     }
 
@@ -245,8 +282,8 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
      */
     void removeAllForTesting() {
         synchronized (mTasksLock) {
-            mTasks.forEach((taskId, task) -> task.destroy());
-            mTasks.clear();
+            mTasksCromite.forEach((taskId, task) -> task.destroy());
+            mTasksCromite.clear();
             mPendingTasks.forEach((taskId, task) -> task.destroy());
             mPendingTasks.clear();
         }
@@ -265,11 +302,17 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
     }
 
     @GuardedBy("mTasksLock")
-    private void removeInternalLocked(int taskId) {
-        var taskRemoved = mTasks.remove(taskId);
+    private void removeInternalLocked(ChromeAndroidTask taskRemoved) {
         if (taskRemoved != null) {
-            mObservers.forEach((observer) -> observer.onTaskRemoved(taskRemoved));
-            taskRemoved.destroy();
+            for (Key key : mTasksCromite.keySet()) {
+                if (key == null) continue;
+                if (mTasksCromite.get(key) == taskRemoved) {
+                    mTasksCromite.remove(key);
+
+                    mObservers.forEach((observer) -> observer.onTaskRemoved(taskRemoved));
+                    taskRemoved.destroy();
+                }
+            }
         }
     }
 
@@ -359,7 +402,7 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
     /** Returns all PENDING and ALIVE Tasks. */
     @GuardedBy("mTasksLock")
     private List<ChromeAndroidTask> getAllTasksLocked() {
-        List<ChromeAndroidTask> tasks = new ArrayList<>(mTasks.values());
+        List<ChromeAndroidTask> tasks = new ArrayList<>(mTasksCromite.values());
         tasks.addAll(mPendingTasks.values());
         return tasks;
     }
diff --git a/chrome/browser/ui/browser_window/public/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTracker.java b/chrome/browser/ui/browser_window/public/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTracker.java
--- a/chrome/browser/ui/browser_window/public/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTracker.java
+++ b/chrome/browser/ui/browser_window/public/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTracker.java
@@ -85,7 +85,7 @@ public interface ChromeAndroidTaskTracker {
      *
      * @param taskId Same as defined by {@link android.app.TaskInfo#taskId}.
      */
-    @Nullable ChromeAndroidTask get(int taskId);
+    @Nullable ChromeAndroidTask get(int taskId, TabModel tabModel);
 
     /**
      * Removes from the internal collection the {@link ChromeAndroidTask} with the given {@code
@@ -93,7 +93,7 @@ public interface ChromeAndroidTaskTracker {
      *
      * @param taskId Same as defined by {@link android.app.TaskInfo#taskId}.
      */
-    void remove(int taskId);
+    //void remove(int taskId);
 
     /**
      * Called when an {@link ActivityWindowAndroid} is destroyed.
@@ -102,6 +102,8 @@ public interface ChromeAndroidTaskTracker {
      */
     void onActivityWindowAndroidDestroy(ActivityWindowAndroid activityWindowAndroid);
 
+    void onActivityWindowAndroidDestroy(ChromeAndroidTask task);
+
     /**
      * Adds an observer which will be called on addition or removal of tasks.
      *
--
