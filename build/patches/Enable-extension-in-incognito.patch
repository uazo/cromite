From: uazo <uazo@users.noreply.github.com>
Date: Thu, 20 Nov 2025 12:53:28 +0000
Subject: Enable extensions in incognito

Full activation of incognito mode in experimental extension

License: GPL-3.0-only - https://spdx.org/licenses/GPL-3.0-only.html
---
 .../chrome/browser/ChromeTabbedActivity.java  | 37 +++++++-
 .../chrome/browser/app/ChromeActivity.java    | 36 ++++++--
 .../customtabs/BaseCustomTabActivity.java     |  2 +-
 .../BaseCustomTabRootUiCoordinator.java       |  4 +-
 .../CustomTabIntentDataProvider.java          |  3 +
 .../tabbed_mode/TabbedRootUiCoordinator.java  |  3 +-
 .../browser/tabmodel/TabModelJniBridge.java   |  4 +-
 .../tabmodel/TabModelSelectorBase.java        |  7 ++
 .../browser/toolbar/ToolbarManager.java       | 13 ++-
 .../chrome/browser/ui/RootUiCoordinator.java  |  6 +-
 .../developer_private_functions.cc            |  3 +-
 .../browser/extensions/extension_tab_util.cc  |  2 +-
 .../tabmodel/IncognitoTabModelImpl.java       | 10 ++-
 .../tabmodel/IncognitoTabModelObserver.java   |  2 +
 .../extensions/extension_actions_bridge.cc    | 23 +++--
 .../extensions/extension_actions_bridge.h     |  4 +-
 .../ui/extensions/ExtensionActionsBridge.java | 26 +++++-
 .../android/tab_model/tab_model_jni_bridge.cc |  4 +
 .../ExtensionActionListCoordinator.java       | 12 ++-
 .../ExtensionActionListMediator.java          | 23 +++--
 .../ExtensionActionsUpdateHelper.java         | 64 +++++++++++--
 .../ExtensionToolbarCoordinator.java          | 13 ++-
 .../ExtensionToolbarCoordinatorImpl.java      | 34 +++++--
 .../extensions/ExtensionsMenuCoordinator.java |  7 +-
 .../extensions/ExtensionsMenuMediator.java    | 14 ++-
 .../browser_window/ChromeAndroidTaskImpl.java |  3 +
 .../ChromeAndroidTaskTrackerFactory.java      |  1 -
 .../ChromeAndroidTaskTrackerImpl.java         | 90 ++++++++++++++-----
 .../ChromeAndroidTaskTracker.java             |  7 +-
 components/tabs/impl/tab_collection.cc        | 16 ++++
 components/tabs/impl/tab_strip_collection.cc  |  4 +-
 31 files changed, 382 insertions(+), 95 deletions(-)

diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
@@ -118,6 +118,7 @@ import org.chromium.chrome.browser.compositor.overlays.strip.StripLayoutHelperMa
 import org.chromium.chrome.browser.compositor.overlays.strip.StripLayoutHelperManager.TabModelStartupInfo;
 import org.chromium.chrome.browser.cookies.CookiesFetcher;
 import org.chromium.chrome.browser.crypto.CipherFactory;
+import org.chromium.chrome.browser.customtabs.CustomTabActivity;
 import org.chromium.chrome.browser.data_sharing.DataSharingIntentUtils;
 import org.chromium.chrome.browser.data_sharing.DataSharingTabGroupUtils;
 import org.chromium.chrome.browser.data_sharing.DataSharingTabManager;
@@ -300,11 +301,13 @@ import org.chromium.chrome.browser.tasks.tab_management.TabSwitcherPaneBase;
 import org.chromium.chrome.browser.tasks.tab_management.TabUiUtils;
 import org.chromium.chrome.browser.tasks.tab_management.TabsSettings;
 import org.chromium.chrome.browser.tasks.tab_management.archived_tabs_auto_delete_promo.ArchivedTabsAutoDeletePromoManager;
+import org.chromium.chrome.browser.tabmodel.IncognitoTabModelObserver;
 import org.chromium.chrome.browser.toolbar.ToolbarIntentMetadata;
 import org.chromium.chrome.browser.toolbar.ToolbarManager;
 import org.chromium.chrome.browser.toolbar.extensions.ExtensionToolbarCoordinator;
 import org.chromium.chrome.browser.toolbar.top.ToolbarControlContainer;
 import org.chromium.chrome.browser.ui.AppLaunchDrawBlocker;
+import org.chromium.chrome.browser.ui.extensions.ExtensionActionsBridge;
 import org.chromium.chrome.browser.ui.IncognitoRestoreAppLaunchDrawBlockerFactory;
 import org.chromium.chrome.browser.ui.RootUiCoordinator;
 import org.chromium.chrome.browser.ui.appmenu.AppMenuPropertiesDelegate;
@@ -822,7 +825,33 @@ public class ChromeTabbedActivity extends ChromeActivity implements PreAttachInt
             mTabModelNotificationDotManager.initWithNative(mTabModelSelector);
             TabModel currentTabModel = mTabModelSelector.getCurrentModel();
             initializeChromeAndroidTask(
-                    BrowserWindowType.NORMAL, currentTabModel, mMultiInstanceManager);
+                    BrowserWindowType.NORMAL, mTabModelSelector.getModel(false), mMultiInstanceManager);
+
+            ProfileManager.addObserver(
+                new ProfileManager.Observer() {
+                    @Override
+                    public void onProfileAdded(Profile profile) {}
+
+                    @Override
+                    public void onProfileDestroyed(Profile profile) {
+                    }
+                });
+
+            mTabModelSelector.addIncognitoTabModelObserver(
+                new IncognitoTabModelObserver() {
+                    @Override
+                    public void wasFirstTabCreated() {
+                        initializeChromeAndroidTask(BrowserWindowType.NORMAL,
+                            mTabModelSelector.getModel(true),
+                            mMultiInstanceManager);
+                    }
+
+                    @Override
+                    public void didDestroyed() {
+                        destroyIncognitoAndroidTask(
+                            mTabModelSelector.getModel(true));
+                    }
+                });
 
             // For saving non-incognito tab closures for Recent Tabs.
             boolean alwaysIncognito = AlwaysIncognitoLinkInterceptor.isAlwaysIncognito();
@@ -2969,7 +2998,7 @@ public class ChromeTabbedActivity extends ChromeActivity implements PreAttachInt
                 mLayoutStateProviderSupplier,
                 getBrowserControlsManager(),
                 getWindowAndroid(),
-                getChromeAndroidTaskSupplier(),
+                (tab) -> getChromeAndroidTask(tab),
                 getLifecycleDispatcher(),
                 getLayoutManagerSupplier(),
                 /* menuOrKeyboardActionController= */ this,
@@ -3885,6 +3914,10 @@ public class ChromeTabbedActivity extends ChromeActivity implements PreAttachInt
             }
             RecordUserAction.record("MobileMenuRecentTabs");
         } else if (id == R.id.extensions_menu_id) {
+            if (getCurrentTabModel().isIncognito()) {
+                CustomTabActivity.showInfoPage(this, UrlConstants.CHROME_EXTENSIONS_URL);
+                return true;
+            }
             LoadUrlParams params =
                     new LoadUrlParams(
                             UrlConstants.CHROME_EXTENSIONS_URL, PageTransition.AUTO_TOPLEVEL);
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
@@ -458,7 +458,7 @@ public abstract class ChromeActivity extends AsyncInitializationActivity
 
     private @Nullable TabStateThemeResourceProvider mThemeResourceProvider;
 
-    private final OneshotSupplierImpl<ChromeAndroidTask> mChromeAndroidTaskSupplier =
+    private final OneshotSupplierImpl<ChromeAndroidTask> mChromeAndroidTaskSupplierInternal =
             new OneshotSupplierImpl<>();
 
     protected ChromeActivity() {
@@ -1123,13 +1123,29 @@ public abstract class ChromeActivity extends AsyncInitializationActivity
                     () -> ExtensionWindowControllerBridgeFactory.create(chromeAndroidTask));
 
             // 5. Make the ChromeAndroidTask available via OneshotSupplier.
-            mChromeAndroidTaskSupplier.set(chromeAndroidTask);
+            if (!currentTabModel.isIncognito())
+                mChromeAndroidTaskSupplierInternal.set(chromeAndroidTask);
+
+            onTopResumedActivityChangedWithNative(/* isTopResumedActivity= */ true);
         }
     }
 
     /** Returns an {@link OneshotSupplier} for {@link ChromeAndroidTask}. */
-    protected final OneshotSupplier<ChromeAndroidTask> getChromeAndroidTaskSupplier() {
-        return mChromeAndroidTaskSupplier;
+    protected final ChromeAndroidTask getChromeAndroidTask(Tab tab) {
+        TabModelSelector modelSelector = getTabModelSelector();
+        TabModel tabModel = modelSelector.getModelForTabId(tab.getId());
+        return ChromeAndroidTaskTrackerFactory.getInstance().get(
+            mChromeAndroidTaskSupplierInternal.get().getId(),
+            tabModel);
+    }
+
+    protected final void destroyIncognitoAndroidTask(TabModel tabModel) {
+        ChromeAndroidTask incognitoTask =
+            ChromeAndroidTaskTrackerFactory.getInstance().get(
+                mChromeAndroidTaskSupplierInternal.get().getId(),
+                tabModel);
+        ChromeAndroidTaskTrackerFactory.getInstance()
+            .onActivityWindowAndroidDestroy(incognitoTask, getWindowAndroid());
     }
 
     @Override
@@ -1799,6 +1815,14 @@ public abstract class ChromeActivity extends AsyncInitializationActivity
     @SuppressLint("NewApi")
     @Override
     protected final void onDestroy() {
+        ActivityWindowAndroid wAndroid = getWindowAndroid();
+        if (wAndroid != null) {
+            var chromeAndroidTaskTracker = ChromeAndroidTaskTrackerFactory.getInstance();
+            if (chromeAndroidTaskTracker != null) {
+                chromeAndroidTaskTracker.onActivityWindowAndroidDestroy(wAndroid);
+            }
+        }
+
         if (mSnackbarManager != null) {
             SnackbarManagerProvider.detach(mSnackbarManager);
         }
@@ -2055,7 +2079,7 @@ public abstract class ChromeActivity extends AsyncInitializationActivity
 
         getProfileProviderSupplier().runSyncOrOnAvailable(this::initializeManualFillingComponent);
 
-        var chromeAndroidTask = getChromeAndroidTaskSupplier().get();
+        var chromeAndroidTask = mChromeAndroidTaskSupplierInternal.get();
         if (chromeAndroidTask != null) {
             chromeAndroidTask.onNativeInitializationFinished();
         }
@@ -2099,7 +2123,7 @@ public abstract class ChromeActivity extends AsyncInitializationActivity
                     && DeviceFormFactor.isNonMultiDisplayContextOnTablet(this)) {
                 HostZoomMap.setTransparentZoomAdjustment(
                         ContentFeatureList.sAndroidMonitorZoomScalingFactor.getValue() / 100.0f);
-            } else if (DeviceInfo.isDesktop()) {
+            } else if (DeviceInfo.isDesktopFalse()) {
                 HostZoomMap.setTransparentZoomAdjustment(
                         ContentFeatureList.sAndroidDesktopZoomScalingFactor.getValue() / 100.0f);
             }
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabActivity.java
@@ -392,7 +392,7 @@ public abstract class BaseCustomTabActivity extends ChromeActivity {
                         getTabModelSelectorSupplier(),
                         getBrowserControlsManager(),
                         getWindowAndroid(),
-                        getChromeAndroidTaskSupplier(),
+                        (tab) -> getChromeAndroidTask(tab),
                         getLifecycleDispatcher(),
                         getLayoutManagerSupplier(),
                         /* menuOrKeyboardActionController= */ this,
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabRootUiCoordinator.java b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabRootUiCoordinator.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabRootUiCoordinator.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabRootUiCoordinator.java
@@ -92,6 +92,7 @@ import org.chromium.chrome.browser.tab.EmptyTabObserver;
 import org.chromium.chrome.browser.tab.RequestDesktopUtils;
 import org.chromium.chrome.browser.tab.Tab;
 import org.chromium.chrome.browser.tab_ui.TabContentManager;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.TabCreatorManager;
 import org.chromium.chrome.browser.tabmodel.TabModelSelector;
 import org.chromium.chrome.browser.toolbar.adaptive.AdaptiveToolbarBehavior;
@@ -124,6 +125,7 @@ import org.chromium.ui.modaldialog.ModalDialogManager;
 
 import java.util.function.BooleanSupplier;
 import java.util.function.Supplier;
+import java.util.function.Function;
 
 /** A {@link RootUiCoordinator} variant that controls UI for {@link BaseCustomTabActivity}. */
 public class BaseCustomTabRootUiCoordinator extends RootUiCoordinator {
@@ -210,7 +212,7 @@ public class BaseCustomTabRootUiCoordinator extends RootUiCoordinator {
             @NonNull ObservableSupplier<TabModelSelector> tabModelSelectorSupplier,
             @NonNull BrowserControlsManager browserControlsManager,
             @NonNull ActivityWindowAndroid windowAndroid,
-            @NonNull OneshotSupplier<ChromeAndroidTask> chromeAndroidTaskSupplier,
+            @NonNull Function<Tab, ChromeAndroidTask> chromeAndroidTaskSupplier,
             @NonNull ActivityLifecycleDispatcher activityLifecycleDispatcher,
             @NonNull ObservableSupplier<LayoutManagerImpl> layoutManagerSupplier,
             @NonNull MenuOrKeyboardActionController menuOrKeyboardActionController,
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabIntentDataProvider.java b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabIntentDataProvider.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabIntentDataProvider.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabIntentDataProvider.java
@@ -341,6 +341,7 @@ public class CustomTabIntentDataProvider extends BrowserServicesIntentDataProvid
 
     private final boolean mEnableUrlBarHiding;
     private boolean mInteractWithBackground;
+    private boolean mIsExtension = false;
     private List<CustomButtonParams> mCustomButtonParams;
     private @Nullable Drawable mCloseButtonIcon;
     private final boolean mIsCloseButtonEnabled;
@@ -724,6 +725,7 @@ public class CustomTabIntentDataProvider extends BrowserServicesIntentDataProvid
         mSideSheetRoundedCornersPosition =
                 getActivitySideSheetRoundedCornersPositionFromIntent(intent);
 
+        mIsExtension = getUrlToLoad().startsWith(UrlConstants.CHROME_EXTENSIONS_URL);
         logCustomTabFeatures(intent, colorScheme);
         String packageName = getClientPackageNameFromSessionOrCallingActivity(mIntent, mSession);
         RecordHistogram.recordBooleanHistogram(
@@ -1367,6 +1369,7 @@ public class CustomTabIntentDataProvider extends BrowserServicesIntentDataProvid
 
     @Override
     public @CustomTabProfileType int getCustomTabMode() {
+        if (mIsExtension) return CustomTabProfileType.REGULAR;
         return AlwaysIncognitoLinkInterceptor.isAlwaysIncognito()
                 ? CustomTabProfileType.INCOGNITO
                 : (ChromeFeatureList.sMayLaunchurlUsesSeparateStoragePartition.isEnabled()
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedRootUiCoordinator.java b/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedRootUiCoordinator.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedRootUiCoordinator.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedRootUiCoordinator.java
@@ -185,6 +185,7 @@ import org.chromium.chrome.browser.toolbar.adaptive.AdaptiveToolbarBehavior;
 import org.chromium.chrome.browser.ui.RootUiCoordinator;
 import org.chromium.chrome.browser.ui.appmenu.AppMenuBlocker;
 import org.chromium.chrome.browser.ui.appmenu.AppMenuDelegate;
+import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask;
 import org.chromium.chrome.browser.ui.default_browser_promo.DefaultBrowserPromoUtils;
 import org.chromium.chrome.browser.ui.desktop_windowing.AppHeaderCoordinator;
 import org.chromium.chrome.browser.ui.desktop_windowing.AppHeaderUtils;
@@ -421,7 +422,7 @@ public class TabbedRootUiCoordinator extends RootUiCoordinator {
             @NonNull OneshotSupplier<LayoutStateProvider> layoutStateProviderOneshotSupplier,
             @NonNull BrowserControlsManager browserControlsManager,
             @NonNull ActivityWindowAndroid windowAndroid,
-            @NonNull OneshotSupplier chromeAndroidTaskSupplier,
+            @NonNull Function<Tab, ChromeAndroidTask> chromeAndroidTaskSupplier,
             @NonNull ActivityLifecycleDispatcher activityLifecycleDispatcher,
             @NonNull ObservableSupplier<LayoutManagerImpl> layoutManagerSupplier,
             @NonNull MenuOrKeyboardActionController menuOrKeyboardActionController,
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelJniBridge.java b/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelJniBridge.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelJniBridge.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelJniBridge.java
@@ -133,10 +133,10 @@ public abstract class TabModelJniBridge implements TabModelInternal {
     @Override
     public void associateWithBrowserWindow(long nativeAndroidBrowserWindow) {
         // Ensure this isn't set multiple times.
-        assert mNativeAndroidBrowserWindow == 0;
+        if (nativeAndroidBrowserWindow != 0) assert mNativeAndroidBrowserWindow == 0;
         mNativeAndroidBrowserWindow = nativeAndroidBrowserWindow;
 
-        assert nativeAndroidBrowserWindow != 0;
+        // assert nativeAndroidBrowserWindow != 0;
         TabModelJniBridgeJni.get()
                 .associateWithBrowserWindow(mNativeTabModelJniBridge, nativeAndroidBrowserWindow);
     }
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelSelectorBase.java b/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelSelectorBase.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelSelectorBase.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelSelectorBase.java
@@ -488,6 +488,13 @@ public abstract class TabModelSelectorBase
         }
     }
 
+    @Override
+    public void didDestroyed() {
+        for (IncognitoTabModelObserver observer : mIncognitoObservers) {
+            observer.didDestroyed();
+        }
+    }
+
     @Override
     public void didBecomeEmpty() {
         for (IncognitoTabModelObserver observer : mIncognitoObservers) {
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/toolbar/ToolbarManager.java b/chrome/android/java/src/org/chromium/chrome/browser/toolbar/ToolbarManager.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/toolbar/ToolbarManager.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/toolbar/ToolbarManager.java
@@ -141,6 +141,7 @@ import org.chromium.chrome.browser.tab.TabObscuringHandler;
 import org.chromium.chrome.browser.tab.TabSelectionType;
 import org.chromium.chrome.browser.tab_ui.TabContentManager;
 import org.chromium.chrome.browser.tab_ui.TabModelDotInfo;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.IncognitoStateProvider;
 import org.chromium.chrome.browser.tabmodel.TabCreatorManager;
 import org.chromium.chrome.browser.tabmodel.TabModel;
@@ -241,6 +242,7 @@ import org.chromium.url.GURL;
 
 import java.util.List;
 import java.util.function.Supplier;
+import java.util.function.Function;
 
 import org.chromium.chrome.browser.flags.ChromeFeatureList;
 import android.view.Gravity;
@@ -366,7 +368,7 @@ public class ToolbarManager
     private TopInsetCoordinator.@Nullable Observer mTopInsetCoordinatorObserver;
     private final SettableNonNullObservableSupplier<@ControlsPosition Integer>
             mToolbarPositionSupplier = ObservableSuppliers.createNonNull(ControlsPosition.NONE);
-    private final OneshotSupplier<ChromeAndroidTask> mChromeAndroidTaskSupplier;
+    private final Function<Tab, ChromeAndroidTask> mChromeAndroidTaskSupplier;
 
     private @MonotonicNonNull HomeButtonCoordinator mHomeButtonCoordinator;
     private @MonotonicNonNull HomePageButtonsCoordinator mHomePageButtonsCoordinator;
@@ -802,7 +804,7 @@ public class ToolbarManager
             ObservableSupplier<Boolean> omniboxFocusStateSupplier,
             OneshotSupplier<Boolean> promoShownOneshotSupplier,
             WindowAndroid windowAndroid,
-            OneshotSupplier<ChromeAndroidTask> chromeAndroidTaskSupplier,
+            Function<Tab, ChromeAndroidTask> chromeAndroidTaskSupplier,
             Supplier<Boolean> isInOverviewModeSupplier,
             Supplier<ModalDialogManager> modalDialogManagerSupplier,
             StatusBarColorController statusBarColorController,
@@ -2424,22 +2426,19 @@ public class ToolbarManager
         ViewStub extensionToolbarStub =
                 mControlContainer.findViewById(R.id.extension_toolbar_container_stub);
         if (extensionToolbarStub != null) {
-            ChromeAndroidTask task = mChromeAndroidTaskSupplier.get();
-            // ChromeAndroidTask is available only on Desktop Android.
-            if (task != null) {
                 mExtensionToolbarCoordinator =
                         ExtensionToolbarCoordinator.maybeCreate(
                                 mActivity,
                                 extensionToolbarStub,
                                 mWindowAndroid,
-                                task,
+                                mChromeAndroidTaskSupplier,
+                                mProfileSupplier,
                                 mActivityTabProvider.asObservable(),
                                 mTabCreatorManager.getTabCreator(false),
                                 getBrowsingModeThemeColorProvider());
                 if (mExtensionToolbarCoordinator != null) {
                     mToolbar.setExtensionToolbarCoordinator(mExtensionToolbarCoordinator);
                 }
-            }
         }
 
         // Must be initialized before Toolbar attempts to use it.
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ui/RootUiCoordinator.java b/chrome/android/java/src/org/chromium/chrome/browser/ui/RootUiCoordinator.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/ui/RootUiCoordinator.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ui/RootUiCoordinator.java
@@ -149,6 +149,7 @@ import org.chromium.chrome.browser.tab.TabSelectionType;
 import org.chromium.chrome.browser.tab_ui.RecyclerViewPosition;
 import org.chromium.chrome.browser.tab_ui.TabContentManager;
 import org.chromium.chrome.browser.tab_ui.TabSwitcher;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.TabCreator;
 import org.chromium.chrome.browser.tabmodel.TabCreatorManager;
 import org.chromium.chrome.browser.tabmodel.TabModel;
@@ -243,6 +244,7 @@ import org.chromium.url.GURL;
 import java.lang.ref.WeakReference;
 import java.util.function.BooleanSupplier;
 import java.util.function.Supplier;
+import java.util.function.Function;
 
 /**
  * The root UI coordinator. This class will eventually be responsible for inflating and managing
@@ -276,7 +278,7 @@ public class RootUiCoordinator
     protected @Nullable AppMenuCoordinator mAppMenuCoordinator;
     private final MenuOrKeyboardActionController mMenuOrKeyboardActionController;
     protected final ActivityWindowAndroid mWindowAndroid;
-    private final OneshotSupplier<ChromeAndroidTask> mChromeAndroidTaskSupplier;
+    private final Function<Tab, ChromeAndroidTask> mChromeAndroidTaskSupplier;
 
     protected final ActivityTabProvider mActivityTabProvider;
     protected ObservableSupplier<ShareDelegate> mShareDelegateSupplier;
@@ -468,7 +470,7 @@ public class RootUiCoordinator
             @NonNull OneshotSupplier<LayoutStateProvider> layoutStateProviderOneshotSupplier,
             @NonNull BrowserControlsManager browserControlsManager,
             @NonNull ActivityWindowAndroid windowAndroid,
-            @NonNull OneshotSupplier<ChromeAndroidTask> chromeAndroidTaskSupplier,
+            @NonNull Function<Tab, ChromeAndroidTask> chromeAndroidTaskSupplier,
             @NonNull ActivityLifecycleDispatcher activityLifecycleDispatcher,
             @NonNull ObservableSupplier<LayoutManagerImpl> layoutManagerSupplier,
             @NonNull MenuOrKeyboardActionController menuOrKeyboardActionController,
diff --git a/chrome/browser/extensions/api/developer_private/developer_private_functions.cc b/chrome/browser/extensions/api/developer_private/developer_private_functions.cc
--- a/chrome/browser/extensions/api/developer_private/developer_private_functions.cc
+++ b/chrome/browser/extensions/api/developer_private/developer_private_functions.cc
@@ -1746,7 +1746,8 @@ DeveloperPrivateDismissSafetyHubExtensionsMenuNotificationFunction::Run() {
   }
 
   Profile* profile = Profile::FromBrowserContext(browser_context());
-  SafetyHubMenuNotificationServiceFactory::GetForProfile(profile)
+  if (auto* menu_notification_service_factory = SafetyHubMenuNotificationServiceFactory::GetForProfile(profile))
+    menu_notification_service_factory
       ->DismissActiveNotificationOfModule(
           safety_hub::SafetyHubModuleType::EXTENSIONS);
   return RespondNow(NoArguments());
diff --git a/chrome/browser/extensions/extension_tab_util.cc b/chrome/browser/extensions/extension_tab_util.cc
--- a/chrome/browser/extensions/extension_tab_util.cc
+++ b/chrome/browser/extensions/extension_tab_util.cc
@@ -1256,7 +1256,7 @@ bool ExtensionTabUtil::OpenOptionsPageFromWebContents(
   if (!url) {
     return false;
   }
-  const bool open_in_tab = ShouldOpenInTab(extension);
+  const bool open_in_tab = false; //ShouldOpenInTab(extension);
 // Opens the url as instructed by `open_in_tab`. On android we take a different
 // path because the `Browser` object is not available.
 // TODO(crbug.com/441209530): Unify the path on android after browser
diff --git a/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelImpl.java b/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelImpl.java
--- a/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelImpl.java
+++ b/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelImpl.java
@@ -145,8 +145,12 @@ class IncognitoTabModelImpl implements IncognitoTabModelInternal {
             return;
         }
 
+        // Disassociate
+        mDelegateModel.associateWithBrowserWindow(/*nativeAndroidBrowserWindow=*/ 0);
+        mNativeAndroidBrowserWindow = 0;
+
         for (IncognitoTabModelObserver observer : mIncognitoObservers) {
-            observer.didBecomeEmpty();
+            observer.didDestroyed();
         }
 
         mDelegateModel
@@ -157,6 +161,10 @@ class IncognitoTabModelImpl implements IncognitoTabModelInternal {
         mCurrentTabSupplier.set(null);
         mTabCountSupplier.set(0);
 
+        for (IncognitoTabModelObserver observer : mIncognitoObservers) {
+            observer.didBecomeEmpty();
+        }
+
         mDelegateModel = EmptyTabModel.getInstance(true);
         for (Callback<TabModelInternal> delegateModelObserver : mDelegateModelObservers) {
             delegateModelObserver.onResult(mDelegateModel);
diff --git a/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelObserver.java b/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelObserver.java
--- a/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelObserver.java
+++ b/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelObserver.java
@@ -33,4 +33,6 @@ public interface IncognitoTabModelObserver {
 
     /** Called when the last tab of the {@link IncognitoTabModel} is closed. */
     default void didBecomeEmpty() {}
+
+    default void didDestroyed() {}
 }
diff --git a/chrome/browser/ui/android/extensions/extension_actions_bridge.cc b/chrome/browser/ui/android/extensions/extension_actions_bridge.cc
--- a/chrome/browser/ui/android/extensions/extension_actions_bridge.cc
+++ b/chrome/browser/ui/android/extensions/extension_actions_bridge.cc
@@ -19,6 +19,8 @@
 #include "extensions/browser/extension_action.h"
 #include "extensions/browser/extension_action_manager.h"
 #include "extensions/browser/extension_registry.h"
+#include "extensions/browser/process_manager.h"
+#include "extensions/browser/process_manager_factory.h"
 #include "ui/color/color_provider_manager.h"
 #include "ui/events/android/key_event_android.h"
 #include "ui/events/event.h"
@@ -60,10 +62,9 @@ void ExtensionActionsBridge::IconObserver::OnIconUpdated() {
 }
 
 ExtensionActionsBridge::ExtensionActionsBridge(
-    BrowserWindowInterface* browser,
+    Profile* profile,
     const base::android::JavaRef<jobject>& java_object)
-    : browser_(browser),
-      profile_(browser->GetProfile()),
+    : profile_(profile),
       java_object_(java_object),
       model_(ToolbarActionsModel::Get(profile_)),
       keybinding_registry_(
@@ -221,6 +222,16 @@ void ExtensionActionsBridge::ClearExtensionData(JNIEnv* env) {
         install_directory, install_updacked_directory));
 }
 
+void ExtensionActionsBridge::CloseBackgroundHosts(JNIEnv* env) {
+  extensions::ProcessManager* manager =
+          extensions::ProcessManagerFactory::GetForBrowserContextIfExists(profile_);
+  if (manager) {
+    manager->CloseBackgroundHosts();
+    ProcessManager::Get(profile_->GetOriginalProfile())
+            ->MaybeCreateStartupBackgroundHosts();
+  }
+}
+
 jni_zero::ScopedJavaLocalRef<jobject>
 ExtensionActionsBridge::HandleKeyDownEvent(
     JNIEnv* env,
@@ -309,11 +320,9 @@ void ExtensionActionsBridge::OnToolbarIconUpdated(
 static jlong JNI_ExtensionActionsBridge_Init(
     JNIEnv* env,
     const base::android::JavaRef<jobject>& java_object,
-    jlong j_browser_window_interface) {
-  BrowserWindowInterface* browser =
-      reinterpret_cast<BrowserWindowInterface*>(j_browser_window_interface);
+    Profile* profile) {
   return reinterpret_cast<jlong>(
-      new ExtensionActionsBridge(browser, java_object));
+      new ExtensionActionsBridge(profile, java_object));
 }
 
 static bool JNI_ExtensionActionsBridge_ExtensionsEnabled(JNIEnv* env,
diff --git a/chrome/browser/ui/android/extensions/extension_actions_bridge.h b/chrome/browser/ui/android/extensions/extension_actions_bridge.h
--- a/chrome/browser/ui/android/extensions/extension_actions_bridge.h
+++ b/chrome/browser/ui/android/extensions/extension_actions_bridge.h
@@ -25,7 +25,7 @@ namespace extensions {
 // This bridge is created and owned by Java UI code.
 class ExtensionActionsBridge : public ToolbarActionsModel::Observer {
  public:
-  ExtensionActionsBridge(BrowserWindowInterface* browser,
+  ExtensionActionsBridge(Profile* profile,
                          const base::android::JavaRef<jobject>& java_object);
   ExtensionActionsBridge(const ExtensionActionsBridge&) = delete;
   ExtensionActionsBridge& operator=(const ExtensionActionsBridge&) = delete;
@@ -53,6 +53,7 @@ class ExtensionActionsBridge : public ToolbarActionsModel::Observer {
       int tab_id,
       content::WebContents* web_contents);
   void ClearExtensionData(JNIEnv* env);
+  void CloseBackgroundHosts(JNIEnv* env);
   jni_zero::ScopedJavaLocalRef<jobject> HandleKeyDownEvent(
       JNIEnv* env,
       const ui::KeyEventAndroid& key_event);
@@ -100,7 +101,6 @@ class ExtensionActionsBridge : public ToolbarActionsModel::Observer {
   // Called by IconObserver to notify that the icon of an action was updated.
   void OnToolbarIconUpdated(const ToolbarActionsModel::ActionId& action_id);
 
-  const raw_ptr<BrowserWindowInterface> browser_;
   const raw_ptr<Profile> profile_;
   const base::android::ScopedJavaGlobalRef<jobject> java_object_;
   const raw_ptr<ToolbarActionsModel> model_;
diff --git a/chrome/browser/ui/android/extensions/java/src/org/chromium/chrome/browser/ui/extensions/ExtensionActionsBridge.java b/chrome/browser/ui/android/extensions/java/src/org/chromium/chrome/browser/ui/extensions/ExtensionActionsBridge.java
--- a/chrome/browser/ui/android/extensions/java/src/org/chromium/chrome/browser/ui/extensions/ExtensionActionsBridge.java
+++ b/chrome/browser/ui/android/extensions/java/src/org/chromium/chrome/browser/ui/extensions/ExtensionActionsBridge.java
@@ -6,6 +6,7 @@ package org.chromium.chrome.browser.ui.extensions;
 
 import android.graphics.Bitmap;
 import android.view.KeyEvent;
+import android.util.ArrayMap;
 
 import androidx.annotation.VisibleForTesting;
 
@@ -17,14 +18,17 @@ import org.jni_zero.NativeMethods;
 import org.chromium.base.ObserverList;
 import org.chromium.base.lifetime.Destroyable;
 import org.chromium.base.lifetime.LifetimeAssert;
+import org.chromium.base.ThreadUtils;
 import org.chromium.build.annotations.NullMarked;
 import org.chromium.build.annotations.Nullable;
 import org.chromium.chrome.browser.profiles.Profile;
+import org.chromium.chrome.browser.profiles.ProfileKeyedMap;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask;
 import org.chromium.content_public.browser.WebContents;
 import org.chromium.extensions.ShowAction;
 
 import java.util.Objects;
+import java.util.Map;
 
 /** A JNI bridge to interact with extension actions for the toolbar. */
 @NullMarked
@@ -34,10 +38,19 @@ public class ExtensionActionsBridge implements Destroyable {
     private long mNativeExtensionActionsBridge;
     private final ObserverList<Observer> mObservers = new ObserverList<>();
 
-    public ExtensionActionsBridge(ChromeAndroidTask task) {
+    private static final ProfileKeyedMap<ExtensionActionsBridge> mExtensionActionsBridges =
+            new ProfileKeyedMap<>((e) -> e.destroy());
+
+    public static ExtensionActionsBridge get(Profile profile) {
+        ThreadUtils.assertOnUiThread();
+        return mExtensionActionsBridges.getForProfile(profile,
+            ExtensionActionsBridge::new);
+    }
+
+    private ExtensionActionsBridge(Profile profile) {
         mNativeExtensionActionsBridge =
                 ExtensionActionsBridgeJni.get()
-                        .init(this, task.getOrCreateNativeBrowserWindowPtr());
+                        .init(this, profile);
     }
 
     /** Represents the result of handling a key event. */
@@ -71,6 +84,7 @@ public class ExtensionActionsBridge implements Destroyable {
 
     @Override
     public void destroy() {
+        closeBackgroundHosts();
         assert mNativeExtensionActionsBridge != 0;
         ExtensionActionsBridgeJni.get().destroy(mNativeExtensionActionsBridge);
         mNativeExtensionActionsBridge = 0;
@@ -245,11 +259,15 @@ public class ExtensionActionsBridge implements Destroyable {
         ExtensionActionsBridgeJni.get().clearExtensionData(mNativeExtensionActionsBridge);
     }
 
+    public void closeBackgroundHosts() {
+        ExtensionActionsBridgeJni.get().closeBackgroundHosts(mNativeExtensionActionsBridge);
+    }
+
     @NativeMethods
     public interface Natives {
         boolean extensionsEnabled(@JniType("Profile*") Profile profile);
 
-        long init(ExtensionActionsBridge bridge, long browserWindowInterfacePtr);
+        long init(ExtensionActionsBridge bridge, @JniType("Profile*") Profile profile);
 
         void destroy(long nativeExtensionActionsBridge);
 
@@ -281,6 +299,8 @@ public class ExtensionActionsBridge implements Destroyable {
 
         void clearExtensionData(long nativeExtensionActionsBridge);
 
+        void closeBackgroundHosts(long nativeExtensionActionsBridge);
+
         HandleKeyEventResult handleKeyDownEvent(
                 long nativeExtensionActionsBridge,
                 @JniType("ui::KeyEventAndroid") KeyEvent keyEvent);
diff --git a/chrome/browser/ui/android/tab_model/tab_model_jni_bridge.cc b/chrome/browser/ui/android/tab_model/tab_model_jni_bridge.cc
--- a/chrome/browser/ui/android/tab_model/tab_model_jni_bridge.cc
+++ b/chrome/browser/ui/android/tab_model/tab_model_jni_bridge.cc
@@ -126,6 +126,10 @@ void TabModelJniBridge::AssociateWithBrowserWindow(
 // BrowserWindowInterface is available on desktop Android, but not other Android
 // builds. For non-desktop Android, this function should be a no-op.
 #if BUILDFLAG(IS_DESKTOP_ANDROID_CROMITE)
+  if (native_android_browser_window == 0) {
+    scoped_unowned_user_data_.reset();
+    return;
+  }
   BrowserWindowInterface* android_browser_window =
       reinterpret_cast<BrowserWindowInterface*>(native_android_browser_window);
   CHECK(android_browser_window != nullptr);
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListCoordinator.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListCoordinator.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListCoordinator.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListCoordinator.java
@@ -12,6 +12,7 @@ import org.chromium.base.lifetime.LifetimeAssert;
 import org.chromium.base.supplier.NullableObservableSupplier;
 import org.chromium.build.annotations.NullMarked;
 import org.chromium.build.annotations.Nullable;
+import org.chromium.chrome.browser.profiles.Profile;
 import org.chromium.chrome.browser.tab.Tab;
 import org.chromium.chrome.browser.toolbar.extensions.ExtensionActionButtonProperties.ListItemType;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask;
@@ -21,6 +22,8 @@ import org.chromium.ui.listmenu.ListMenuButton;
 import org.chromium.ui.modelutil.MVCListAdapter.ModelList;
 import org.chromium.ui.modelutil.ViewGroupAdapter;
 
+import java.util.function.Function;
+
 /**
  * Root component for the extension action buttons. Exposes public API for external consumers to
  * interact with the buttons and affect their states.
@@ -28,6 +31,7 @@ import org.chromium.ui.modelutil.ViewGroupAdapter;
 @NullMarked
 public class ExtensionActionListCoordinator implements Destroyable {
     private final ExtensionActionListContainer mContainer;
+    private final ListMenuButton mExtensionsMenuButton;
     private final ModelList mModels;
     private final ExtensionActionListMediator mMediator;
     private final ViewGroupAdapter mAdapter;
@@ -36,15 +40,18 @@ public class ExtensionActionListCoordinator implements Destroyable {
     public ExtensionActionListCoordinator(
             Context context,
             ExtensionActionListContainer container,
+            ListMenuButton extensionsMenuButton,
             WindowAndroid windowAndroid,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
+            NullableObservableSupplier<Profile> profileSupplier,
             NullableObservableSupplier<Tab> currentTabSupplier) {
         mContainer = container;
+        mExtensionsMenuButton = extensionsMenuButton;
 
         mModels = new ModelList();
         mMediator =
                 new ExtensionActionListMediator(
-                        context, windowAndroid, mModels, task, currentTabSupplier);
+                        context, windowAndroid, mModels, task, profileSupplier, currentTabSupplier);
         mAdapter =
                 new ViewGroupAdapter.Builder(mContainer, mModels)
                         .registerType(
@@ -69,6 +76,7 @@ public class ExtensionActionListCoordinator implements Destroyable {
 
     /** Performs a click on the button for the given action. */
     public void click(String actionId) {
+        mExtensionsMenuButton.dismiss();
         for (int i = 0; i < mModels.size(); i++) {
             if (mModels.get(i).model.get(ExtensionActionButtonProperties.ID).equals(actionId)) {
                 mContainer.getChildAt(i).performClick();
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListMediator.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListMediator.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListMediator.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListMediator.java
@@ -15,6 +15,7 @@ import org.chromium.base.supplier.NullableObservableSupplier;
 import org.chromium.build.annotations.NullMarked;
 import org.chromium.build.annotations.Nullable;
 import org.chromium.chrome.browser.extensions.ContextMenuSource;
+import org.chromium.chrome.browser.profiles.Profile;
 import org.chromium.chrome.browser.tab.Tab;
 import org.chromium.chrome.browser.toolbar.MenuBuilderHelper;
 import org.chromium.chrome.browser.toolbar.extensions.ExtensionActionButtonProperties.ListItemType;
@@ -31,6 +32,8 @@ import org.chromium.ui.modelutil.MVCListAdapter.ListItem;
 import org.chromium.ui.modelutil.MVCListAdapter.ModelList;
 import org.chromium.ui.modelutil.PropertyModel;
 
+import java.util.function.Function;
+
 @NullMarked
 class ExtensionActionListMediator implements Destroyable {
     private static final String TAG = "EALMediator";
@@ -38,7 +41,7 @@ class ExtensionActionListMediator implements Destroyable {
     private final Context mContext;
     private final WindowAndroid mWindowAndroid;
     private final ModelList mModels;
-    private final ChromeAndroidTask mTask;
+    private final Function<Tab, ChromeAndroidTask> mTaskSupplier;
     private final ExtensionActionsUpdateHelper mExtensionActionsUpdateHelper;
 
     private final ActionsUpdateDelegate mActionsUpdateDelegate = new ActionsUpdateDelegate();
@@ -51,16 +54,17 @@ class ExtensionActionListMediator implements Destroyable {
             Context context,
             WindowAndroid windowAndroid,
             ModelList models,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
+            NullableObservableSupplier<Profile> profileSupplier,
             NullableObservableSupplier<Tab> currentTabSupplier) {
         mContext = context;
         mWindowAndroid = windowAndroid;
         mModels = models;
-        mTask = task;
+        mTaskSupplier = task;
 
         mExtensionActionsUpdateHelper =
                 new ExtensionActionsUpdateHelper(
-                        mModels, task, currentTabSupplier, mActionsUpdateDelegate);
+                        mModels, profileSupplier, currentTabSupplier, mActionsUpdateDelegate);
     }
 
     @Override
@@ -111,8 +115,13 @@ class ExtensionActionListMediator implements Destroyable {
         }
         int tabId = currentTab.getId();
 
+        ChromeAndroidTask task = mTaskSupplier.apply(currentTab);
+        if (task == null) {
+            return;
+        }
+
         ExtensionActionPopupContents contents =
-                ExtensionActionPopupContents.create(mTask, actionId, tabId);
+                ExtensionActionPopupContents.create(task, actionId, tabId);
         assert mCurrentPopup == null;
         mCurrentPopup =
                 new ExtensionActionPopup(mContext, mWindowAndroid, buttonView, actionId, contents);
@@ -131,9 +140,11 @@ class ExtensionActionListMediator implements Destroyable {
             return;
         }
 
+        ChromeAndroidTask task = mTaskSupplier.apply(currentTab);
+
         ExtensionActionContextMenuBridge bridge =
                 new ExtensionActionContextMenuBridge(
-                        mTask, actionId, webContents, ContextMenuSource.TOOLBAR_ACTION);
+                        task, actionId, webContents, ContextMenuSource.TOOLBAR_ACTION);
 
         ExtensionActionContextMenuUtils.showContextMenu(
                 mContext, buttonView, bridge, MenuBuilderHelper.getRectProvider(buttonView), null);
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionsUpdateHelper.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionsUpdateHelper.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionsUpdateHelper.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionsUpdateHelper.java
@@ -9,6 +9,7 @@ import org.chromium.base.lifetime.Destroyable;
 import org.chromium.base.supplier.NullableObservableSupplier;
 import org.chromium.build.annotations.NullMarked;
 import org.chromium.build.annotations.Nullable;
+import org.chromium.chrome.browser.profiles.Profile;
 import org.chromium.chrome.browser.tab.Tab;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask;
 import org.chromium.chrome.browser.ui.extensions.ExtensionActionsBridge;
@@ -46,32 +47,35 @@ public class ExtensionActionsUpdateHelper implements Destroyable {
         void onUpdateFinished();
     }
 
+    private final NullableObservableSupplier<Profile> mProfileSupplier;
     private final NullableObservableSupplier<Tab> mCurrentTabSupplier;
     private final ActionsUpdateDelegate mActionsUpdateDelegate;
     private final ModelList mModels;
-    private final ExtensionActionsBridge mExtensionActionsBridge;
 
+    private final Callback<@Nullable Profile> mProfileUpdatedCallback = this::onProfileUpdated;
     private final Callback<@Nullable Tab> mTabChangedCallback = this::onTabChanged;
     private final ActionsObserver mActionsObserver = new ActionsObserver();
 
+    @Nullable private ExtensionActionsBridge mExtensionActionsBridge;
+    @Nullable private Profile mProfile;
     @Nullable private Tab mCurrentTab;
 
     public ExtensionActionsUpdateHelper(
             ModelList models,
-            ChromeAndroidTask task,
+            NullableObservableSupplier<Profile> profileSupplier,
             NullableObservableSupplier<Tab> currentTabSupplier,
             ActionsUpdateDelegate delegate) {
         mModels = models;
+        mProfileSupplier = profileSupplier;
         mCurrentTabSupplier = currentTabSupplier;
         mActionsUpdateDelegate = delegate;
-        mExtensionActionsBridge = new ExtensionActionsBridge(task);
 
+        mProfileSupplier.addObserver(mProfileUpdatedCallback);
         mCurrentTabSupplier.addObserver(mTabChangedCallback);
-        mExtensionActionsBridge.addObserver(mActionsObserver);
     }
 
     private void maybeUpdateAllActions() {
-        if (mCurrentTab == null) {
+        if (mProfile == null || mExtensionActionsBridge == null || mCurrentTab == null) {
             mModels.clear();
             return;
         }
@@ -98,6 +102,35 @@ public class ExtensionActionsUpdateHelper implements Destroyable {
         mActionsUpdateDelegate.onUpdateFinished();
     }
 
+    private void onProfileUpdated(@Nullable Profile profile) {
+        if (profile == mProfile) {
+            return;
+        }
+
+        mActionsUpdateDelegate.onUpdateStarted();
+
+        if (mExtensionActionsBridge != null) {
+            mExtensionActionsBridge.removeObserver(mActionsObserver);
+        }
+        mExtensionActionsBridge = null;
+        mProfile = profile;
+
+        if (mProfile != null) {
+            mExtensionActionsBridge = ExtensionActionsBridge.get(mProfile);
+            if (mExtensionActionsBridge != null) {
+                mExtensionActionsBridge.addObserver(mActionsObserver);
+            }
+        }
+
+        mModels.clear();
+
+        if (mCurrentTab != null && mCurrentTab.getProfile() != mProfile) {
+            return;
+        }
+
+        maybeUpdateAllActions();
+    }
+
     private void onTabChanged(@Nullable Tab tab) {
         if (tab == mCurrentTab) {
             return;
@@ -116,9 +149,21 @@ public class ExtensionActionsUpdateHelper implements Destroyable {
         }
 
         mCurrentTab = tab;
+
+        // If the tab belongs to a different profile, onProfileUpdated will be called soon, so
+        // do not update actions now to avoid duplicated updates.
+        if (tab.getProfile() != mProfile) {
+            return;
+        }
+
         maybeUpdateAllActions();
     }
 
+    /** Returns the profile. */
+    public @Nullable Profile getProfile() {
+        return mProfile;
+    }
+
     /** Returns the current tab. */
     public @Nullable Tab getCurrentTab() {
         return mCurrentTab;
@@ -131,11 +176,16 @@ public class ExtensionActionsUpdateHelper implements Destroyable {
 
     @Override
     public void destroy() {
-        mExtensionActionsBridge.removeObserver(mActionsObserver);
+        if (mExtensionActionsBridge != null) {
+            mExtensionActionsBridge.removeObserver(mActionsObserver);
+        }
+
+        mProfileSupplier.removeObserver(mProfileUpdatedCallback);
         mCurrentTabSupplier.removeObserver(mTabChangedCallback);
-        mExtensionActionsBridge.destroy();
 
         mCurrentTab = null;
+        mExtensionActionsBridge = null;
+        mProfile = null;
     }
 
     private class ActionsObserver implements ExtensionActionsBridge.Observer {
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinator.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinator.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinator.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinator.java
@@ -14,13 +14,17 @@ import org.chromium.base.supplier.NullableObservableSupplier;
 import org.chromium.build.annotations.Initializer;
 import org.chromium.build.annotations.NullMarked;
 import org.chromium.build.annotations.Nullable;
+import org.chromium.chrome.browser.profiles.Profile;
 import org.chromium.chrome.browser.tab.Tab;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.TabCreator;
 import org.chromium.chrome.browser.theme.ThemeColorProvider;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask;
 import org.chromium.chrome.browser.ui.extensions.ExtensionUi;
 import org.chromium.ui.base.WindowAndroid;
 
+import java.util.function.Function;
+
 /**
  * The coordinator of the extension-related toolbar UI.
  *
@@ -41,12 +45,13 @@ public interface ExtensionToolbarCoordinator extends Destroyable {
             Context context,
             ViewStub extensionToolbarStub,
             WindowAndroid windowAndroid,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
+            NullableObservableSupplier<Profile> profileSupplier,
             NullableObservableSupplier<Tab> currentTabSupplier,
             TabCreator tabCreator,
             ThemeColorProvider themeColorProvider) {
         // Check if the extension UI is enabled first.
-        if (!ExtensionUi.isEnabled(task.getProfile())) {
+        if (!ExtensionUi.isEnabled(profileSupplier.get())) {
             return null;
         }
 
@@ -60,6 +65,7 @@ public interface ExtensionToolbarCoordinator extends Destroyable {
                 extensionToolbarStub,
                 windowAndroid,
                 task,
+                profileSupplier,
                 currentTabSupplier,
                 tabCreator,
                 themeColorProvider);
@@ -77,7 +83,8 @@ public interface ExtensionToolbarCoordinator extends Destroyable {
             Context context,
             ViewStub extensionToolbarStub,
             WindowAndroid windowAndroid,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
+            NullableObservableSupplier<Profile> profileSupplier,
             NullableObservableSupplier<Tab> currentTabSupplier,
             TabCreator tabCreator,
             ThemeColorProvider themeColorProvider);
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinatorImpl.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinatorImpl.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinatorImpl.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinatorImpl.java
@@ -15,7 +15,9 @@ import org.chromium.base.supplier.NullableObservableSupplier;
 import org.chromium.build.annotations.NullMarked;
 import org.chromium.build.annotations.Nullable;
 import org.chromium.build.annotations.ServiceImpl;
+import org.chromium.chrome.browser.profiles.Profile;
 import org.chromium.chrome.browser.tab.Tab;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.TabCreator;
 import org.chromium.chrome.browser.theme.ThemeColorProvider;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask;
@@ -24,40 +26,42 @@ import org.chromium.chrome.browser.ui.extensions.ExtensionUi;
 import org.chromium.chrome.browser.ui.extensions.R;
 import org.chromium.ui.base.WindowAndroid;
 
+import java.util.function.Function;
+
 /** The implementation of {@link ExtensionToolbarCoordinator}. */
 @NullMarked
 @ServiceImpl(ExtensionToolbarCoordinator.class)
 public class ExtensionToolbarCoordinatorImpl implements ExtensionToolbarCoordinator {
     private final @Nullable LifetimeAssert mLifetimeAssert = LifetimeAssert.create(this);
 
-    private ExtensionActionsBridge mBridge;
     private ExtensionActionListCoordinator mExtensionActionListCoordinator;
     private ExtensionsMenuCoordinator mExtensionsMenuCoordinator;
+    private NullableObservableSupplier<Tab> mCurrentTabSupplier;
+    Function<Tab, ChromeAndroidTask> mTaskSupplier;
 
     @Override
     public void initializeWithNative(
             Context context,
             ViewStub extensionToolbarStub,
             WindowAndroid windowAndroid,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
+            NullableObservableSupplier<Profile> profileSupplier,
             NullableObservableSupplier<Tab> currentTabSupplier,
             TabCreator tabCreator,
             ThemeColorProvider themeColorProvider) {
-        mBridge = new ExtensionActionsBridge(task);
+        mCurrentTabSupplier = currentTabSupplier;
+        mTaskSupplier = task;
 
         extensionToolbarStub.setLayoutResource(R.layout.extension_toolbar_container);
         LinearLayout container = (LinearLayout) extensionToolbarStub.inflate();
-        mProfileSupplier.addObserver((profile) -> {
-            if (!ExtensionUi.isEnabled(profileSupplier.get())) {
-                container.setVisibility(View.GONE);
-            }
-        });
         mExtensionActionListCoordinator =
                 new ExtensionActionListCoordinator(
                         context,
                         container.findViewById(R.id.extension_action_list),
+                        container.findViewById(R.id.extensions_menu_button),
                         windowAndroid,
                         task,
+                        profileSupplier,
                         currentTabSupplier);
         mExtensionsMenuCoordinator =
                 new ExtensionsMenuCoordinator(
@@ -65,6 +69,7 @@ public class ExtensionToolbarCoordinatorImpl implements ExtensionToolbarCoordina
                         container.findViewById(R.id.extensions_menu_button),
                         themeColorProvider,
                         task,
+                        profileSupplier,
                         currentTabSupplier,
                         tabCreator,
                         mExtensionActionListCoordinator);
@@ -74,7 +79,6 @@ public class ExtensionToolbarCoordinatorImpl implements ExtensionToolbarCoordina
     public void destroy() {
         mExtensionsMenuCoordinator.destroy();
         mExtensionActionListCoordinator.destroy();
-        mBridge.destroy();
         LifetimeAssert.setSafeToGc(mLifetimeAssert, true);
     }
 
@@ -85,6 +89,18 @@ public class ExtensionToolbarCoordinatorImpl implements ExtensionToolbarCoordina
             return false;
         }
 
+        Tab currentTab = mCurrentTabSupplier.get();
+        if (currentTab == null) {
+            return false;
+        }
+
+        ChromeAndroidTask task = mTaskSupplier.apply(currentTab);
+        if (task == null) {
+            return false;
+        }
+
+        ExtensionActionsBridge mBridge = ExtensionActionsBridge.get(currentTab.getProfile());
+
         ExtensionActionsBridge.HandleKeyEventResult result = mBridge.handleKeyDownEvent(event);
         if (result.handled) {
             return true;
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuCoordinator.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuCoordinator.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuCoordinator.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuCoordinator.java
@@ -18,6 +18,7 @@ import org.chromium.base.lifetime.Destroyable;
 import org.chromium.base.supplier.NullableObservableSupplier;
 import org.chromium.build.annotations.NullMarked;
 import org.chromium.build.annotations.Nullable;
+import org.chromium.chrome.browser.profiles.Profile;
 import org.chromium.chrome.browser.tab.Tab;
 import org.chromium.chrome.browser.tab.TabLaunchType;
 import org.chromium.chrome.browser.tabmodel.TabCreator;
@@ -40,6 +41,8 @@ import org.chromium.ui.modelutil.PropertyModelChangeProcessor;
 import org.chromium.ui.modelutil.SimpleRecyclerViewAdapter;
 import org.chromium.ui.widget.RectProvider;
 
+import java.util.function.Function;
+
 /**
  * Coordinator for the extensions menu, accessed from the puzzle icon in the toolbar. This class is
  * responsible for the button and the menu.
@@ -75,7 +78,8 @@ public class ExtensionsMenuCoordinator implements Destroyable {
             Context context,
             ListMenuButton extensionsMenuButton,
             ThemeColorProvider themeColorProvider,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
+            NullableObservableSupplier<Profile> profileSupplier,
             NullableObservableSupplier<Tab> currentTabSupplier,
             TabCreator tabCreator,
             ExtensionActionListCoordinator extensionActionListCoordinator) {
@@ -138,6 +142,7 @@ public class ExtensionsMenuCoordinator implements Destroyable {
                 new ExtensionsMenuMediator(
                         mContext,
                         task,
+                        profileSupplier,
                         mCurrentTabSupplier,
                         mExtensionModels,
                         () -> {
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuMediator.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuMediator.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuMediator.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuMediator.java
@@ -13,6 +13,7 @@ import org.chromium.base.lifetime.Destroyable;
 import org.chromium.base.supplier.NullableObservableSupplier;
 import org.chromium.build.annotations.NullMarked;
 import org.chromium.chrome.browser.extensions.ContextMenuSource;
+import org.chromium.chrome.browser.profiles.Profile;
 import org.chromium.chrome.browser.tab.Tab;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask;
 import org.chromium.chrome.browser.toolbar.extensions.ExtensionActionListCoordinator;
@@ -26,6 +27,8 @@ import org.chromium.ui.modelutil.MVCListAdapter.ModelList;
 import org.chromium.ui.modelutil.PropertyModel;
 import org.chromium.ui.widget.RectProvider;
 
+import java.util.function.Function;
+
 /**
  * Mediator for the extensions menu. This class is responsible for listening to changes in the
  * extensions and updating the model accordingly.
@@ -34,7 +37,7 @@ import org.chromium.ui.widget.RectProvider;
 class ExtensionsMenuMediator implements Destroyable {
     private final ActionsUpdateDelegate mActionsUpdateDelegate = new ActionsUpdateDelegate();
     private final Context mContext;
-    private final ChromeAndroidTask mTask;
+    private final Function<Tab, ChromeAndroidTask> mTask;
     private final Runnable mOnUpdateFinishedRunnable;
     private final ExtensionActionsUpdateHelper mExtensionActionsUpdateHelper;
     private final View mRootView;
@@ -42,7 +45,8 @@ class ExtensionsMenuMediator implements Destroyable {
 
     public ExtensionsMenuMediator(
             Context context,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
+            NullableObservableSupplier<Profile> profileSupplier,
             NullableObservableSupplier<Tab> currentTabSupplier,
             ModelList extensionModels,
             Runnable onUpdateFinishedRunnable,
@@ -56,7 +60,7 @@ class ExtensionsMenuMediator implements Destroyable {
 
         mExtensionActionsUpdateHelper =
                 new ExtensionActionsUpdateHelper(
-                        extensionModels, task, currentTabSupplier, mActionsUpdateDelegate);
+                        extensionModels, profileSupplier, currentTabSupplier, mActionsUpdateDelegate);
     }
 
     private static class RelativeViewRectProvider extends RectProvider {
@@ -99,9 +103,11 @@ class ExtensionsMenuMediator implements Destroyable {
             return;
         }
 
+        ChromeAndroidTask task = mTask.apply(currentTab);
+
         ExtensionActionContextMenuBridge bridge =
                 new ExtensionActionContextMenuBridge(
-                        mTask, actionId, webContents, ContextMenuSource.MENU_ITEM);
+                        task, actionId, webContents, ContextMenuSource.MENU_ITEM);
 
         ExtensionActionContextMenuUtils.showContextMenu(
                 mContext,
diff --git a/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskImpl.java b/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskImpl.java
--- a/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskImpl.java
+++ b/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskImpl.java
@@ -440,6 +440,9 @@ final class ChromeAndroidTaskImpl
         if (isActivityToRemoveAtTop) {
             registerListenersForTopActivity();
         }
+
+        // (5) remove UnownedUserDataHost
+        topActivityScopedObjects.mTabModel.associateWithBrowserWindow(0);
     }
 
     @Override
diff --git a/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerFactory.java b/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerFactory.java
--- a/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerFactory.java
+++ b/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerFactory.java
@@ -21,7 +21,6 @@ public final class ChromeAndroidTaskTrackerFactory {
     public static ChromeAndroidTaskTracker getInstance() {
         // TODO(crbug.com/473636857): Remove once this is properly implemented on non-desktop
         // platforms.
-        if (!DeviceInfo.isDesktop()) return null;
 
         return ChromeAndroidTaskTrackerImpl.getInstance();
     }
diff --git a/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerImpl.java b/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerImpl.java
--- a/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerImpl.java
+++ b/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerImpl.java
@@ -23,6 +23,7 @@ import org.chromium.build.annotations.Nullable;
 import org.chromium.chrome.browser.customtabs.PopupIntentCreatorProvider;
 import org.chromium.chrome.browser.incognito.IncognitoUtils;
 import org.chromium.chrome.browser.multiwindow.MultiInstanceManager;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask.PendingTaskInfo;
 import org.chromium.chrome.browser.util.WindowFeatures;
 import org.chromium.ui.base.ActivityWindowAndroid;
@@ -39,6 +40,30 @@ import java.util.Map;
 final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
     private static final String TAG = "CrAndroidTaskTracker";
 
+    private static class Key {
+        public final Integer mTaskId;
+        public final TabModel mTabModel;
+
+        public Key(Integer taskId, TabModel tabModel) {
+            mTaskId = taskId;
+            mTabModel = tabModel;
+        }
+
+        @Override
+        public boolean equals(Object obj) {
+            assert obj instanceof Key : "Wrong key.";
+
+            Key ref = (Key) obj;
+            return this.mTaskId.equals(ref.mTaskId)
+                   && this.mTabModel.equals(ref.mTabModel);
+        }
+
+        @Override
+        public int hashCode() {
+            return mTaskId.hashCode() ^ mTabModel.hashCode();
+        }
+    }
+
     private static @Nullable ChromeAndroidTaskTrackerImpl sInstance;
 
     private static boolean sPausePendingTaskActivityCreationForTesting;
@@ -56,7 +81,7 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
      * Maps {@link ChromeAndroidTask} IDs to their instances. This reflects the {@link
      * ChromeAndroidTask}'s ID when it is alive, and is different from its ID in the pending state.
      */
-    private final Map<Integer, ChromeAndroidTask> mTasks = new ArrayMap<>();
+    private final Map<Key, ChromeAndroidTask> mTasksCromite = new ArrayMap<>();
 
     /**
      * Maps pending {@link ChromeAndroidTask} IDs to their instances. This reflects the {@link
@@ -86,7 +111,8 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
         ThreadUtils.assertOnUiThread();
         int taskId = getTaskId(activityScopedObjects.mActivityWindowAndroid);
 
-        var existingTask = mTasks.get(taskId);
+        var key = new Key(taskId, activityScopedObjects.mTabModel);
+        var existingTask = mTasksCromite.get(key);
         if (existingTask != null) {
             assert existingTask.getBrowserWindowType() == browserWindowType
                     : "The browser window type of an existing task can't be changed.";
@@ -98,12 +124,12 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
             ChromeAndroidTask pendingTask = mPendingTasks.remove(pendingId);
             assert pendingTask != null : "Invalid pendingId provided.";
             pendingTask.addActivityScopedObjects(activityScopedObjects);
-            mTasks.put(taskId, pendingTask);
+            mTasksCromite.put(key, pendingTask);
             return pendingTask;
         }
 
         var newTask = new ChromeAndroidTaskImpl(browserWindowType, activityScopedObjects);
-        mTasks.put(taskId, newTask);
+        mTasksCromite.put(key, newTask);
         mObservers.forEach((observer) -> observer.onTaskAdded(newTask));
         return newTask;
     }
@@ -141,23 +167,38 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
 
     @Override
     @Nullable
-    public ChromeAndroidTask get(int taskId) {
+    public ChromeAndroidTask get(int taskId, TabModel tabModel) {
         ThreadUtils.assertOnUiThread();
-        return mTasks.get(taskId);
+        var key = new Key(taskId, tabModel);
+        return mTasksCromite.get(key);
     }
 
-    @Override
-    public void remove(int taskId) {
-        ThreadUtils.assertOnUiThread();
-        removeInternal(taskId);
-    }
+
+    // @Override
+    // public void remove(int taskId) {
+    //    ThreadUtils.assertOnUiThread();
+    //    removeInternal(taskId);
+    //    }
 
     @Override
     public void onActivityWindowAndroidDestroy(ActivityWindowAndroid activityWindowAndroid) {
         ThreadUtils.assertOnUiThread();
         int taskId = getTaskId(activityWindowAndroid);
-        var task = mTasks.get(taskId);
 
+        for (Key key : mTasksCromite.keySet()) {
+            if (key == null) continue;
+            if (key.mTaskId != taskId) continue;
+
+            var task = mTasksCromite.get(key);
+            if (task.getTopActivityWindowAndroid() != activityWindowAndroid) {
+                continue;
+            }
+            onActivityWindowAndroidDestroy(task, activityWindowAndroid);
+        }
+    }
+
+    @Override
+    public void onActivityWindowAndroidDestroy(ChromeAndroidTask task, ActivityWindowAndroid activityWindowAndroid) {
         if (task == null) {
             return;
         }
@@ -177,7 +218,7 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
         // In the future, we can register a Task listener when a ChromeAndroidTask is created,
         // then destroy it when notified of the Task removal.
         if (task.getTopActivityWindowAndroid() == null) {
-            removeInternal(taskId);
+            removeInternal(task);
         }
     }
 
@@ -239,8 +280,8 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
      */
     void removeAllForTesting() {
         ThreadUtils.assertOnUiThread();
-        mTasks.forEach((taskId, task) -> task.destroy());
-        mTasks.clear();
+        mTasksCromite.forEach((taskId, task) -> task.destroy());
+        mTasksCromite.clear();
         mPendingTasks.forEach((taskId, task) -> task.destroy());
         mPendingTasks.clear();
     }
@@ -275,11 +316,17 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
                 pendingTaskInfo.mIntent, pendingTaskInfo.mCreateParams.getInitialBounds());
     }
 
-    private void removeInternal(int taskId) {
-        var taskRemoved = mTasks.remove(taskId);
+    private void removeInternal(ChromeAndroidTask taskRemoved) {
         if (taskRemoved != null) {
-            mObservers.forEach((observer) -> observer.onTaskRemoved(taskRemoved));
-            taskRemoved.destroy();
+            for (Key key : mTasksCromite.keySet()) {
+                if (key == null) continue;
+                if (mTasksCromite.get(key) == taskRemoved) {
+                    mTasksCromite.remove(key);
+
+                    mObservers.forEach((observer) -> observer.onTaskRemoved(taskRemoved));
+                    taskRemoved.destroy();
+                }
+            }
         }
     }
 
@@ -314,7 +361,8 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
         @BrowserWindowType int browserWindowType = createParams.getWindowType();
         switch (browserWindowType) {
             case BrowserWindowType.NORMAL:
-                for (ChromeAndroidTask task : mTasks.values()) {
+                List<ChromeAndroidTask> tasks = new ArrayList<>(mTasksCromite.values());
+                for (ChromeAndroidTask task : tasks) {
                     var intent = task.createIntentForNormalBrowserWindow(isIncognito);
                     if (intent != null) {
                         return intent;
@@ -360,7 +408,7 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
 
     /** Returns all PENDING and ALIVE Tasks. */
     private List<ChromeAndroidTask> getAllTasks() {
-        List<ChromeAndroidTask> tasks = new ArrayList<>(mTasks.values());
+        List<ChromeAndroidTask> tasks = new ArrayList<>(mTasksCromite.values());
         tasks.addAll(mPendingTasks.values());
         return tasks;
     }
diff --git a/chrome/browser/ui/browser_window/public/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTracker.java b/chrome/browser/ui/browser_window/public/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTracker.java
--- a/chrome/browser/ui/browser_window/public/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTracker.java
+++ b/chrome/browser/ui/browser_window/public/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTracker.java
@@ -8,6 +8,7 @@ import org.chromium.base.JniOnceCallback;
 import org.chromium.build.annotations.NullMarked;
 import org.chromium.build.annotations.Nullable;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask.ActivityScopedObjects;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.ui.base.ActivityWindowAndroid;
 
 /**
@@ -83,7 +84,7 @@ public interface ChromeAndroidTaskTracker {
      *
      * @param taskId Same as defined by {@link android.app.TaskInfo#taskId}.
      */
-    @Nullable ChromeAndroidTask get(int taskId);
+    @Nullable ChromeAndroidTask get(int taskId, TabModel tabModel);
 
     /**
      * Removes from the internal collection the {@link ChromeAndroidTask} with the given {@code
@@ -91,7 +92,7 @@ public interface ChromeAndroidTaskTracker {
      *
      * @param taskId Same as defined by {@link android.app.TaskInfo#taskId}.
      */
-    void remove(int taskId);
+    //void remove(int taskId);
 
     /**
      * Called when an {@link ActivityWindowAndroid} is destroyed.
@@ -100,6 +101,8 @@ public interface ChromeAndroidTaskTracker {
      */
     void onActivityWindowAndroidDestroy(ActivityWindowAndroid activityWindowAndroid);
 
+    void onActivityWindowAndroidDestroy(ChromeAndroidTask task, ActivityWindowAndroid activityWindowAndroid);
+
     /**
      * Adds an observer which will be called on addition or removal of tasks.
      *
diff --git a/components/tabs/impl/tab_collection.cc b/components/tabs/impl/tab_collection.cc
--- a/components/tabs/impl/tab_collection.cc
+++ b/components/tabs/impl/tab_collection.cc
@@ -137,6 +137,22 @@ TabCollection::TabCollection(Type type,
 
 TabCollection::~TabCollection() {
   DispatchPendingNotifications();
+
+  auto& childrens = GetChildren();
+  for (auto it = childrens.begin(); it != childrens.end(); ) {
+    auto& child = *it;
+    if (std::holds_alternative<std::unique_ptr<TabInterface>>(child)) {
+      TabInterface* tab =
+          std::get<std::unique_ptr<TabInterface>>(child).get();
+      auto removed_tab = MaybeRemoveTab(tab);
+    } else if (std::holds_alternative<std::unique_ptr<TabCollection>>(child)) {
+      TabCollection* collection =
+          std::get<std::unique_ptr<TabCollection>>(child).get();
+      auto removed_collection = MaybeRemoveCollection(collection);
+    } else {
+      it++;
+    }
+  }
 }
 
 void TabCollection::AddObserver(TabCollectionObserver* observer) const {
diff --git a/components/tabs/impl/tab_strip_collection.cc b/components/tabs/impl/tab_strip_collection.cc
--- a/components/tabs/impl/tab_strip_collection.cc
+++ b/components/tabs/impl/tab_strip_collection.cc
@@ -327,13 +327,13 @@ std::unique_ptr<TabInterface> TabStripCollection::RemoveTabAtIndexRecursive(
 std::unique_ptr<TabInterface> TabStripCollection::MaybeRemoveTab(
     TabInterface* tab) {
   CHECK(tab);
-  return nullptr;
+  return RemoveTabImpl(tab);
 }
 
 std::unique_ptr<TabCollection> TabStripCollection::MaybeRemoveCollection(
     TabCollection* collection) {
   CHECK(collection);
-  return nullptr;
+  return TabStripCollection::RemoveTabCollection(collection);
 }
 
 void TabStripCollection::InsertTabCollectionAt(
--
