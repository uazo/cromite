From: uazo <uazo@users.noreply.github.com>
Date: Thu, 20 Nov 2025 12:53:28 +0000
Subject: Enable extensions in incognito

Full activation of incognito mode in experimental extension

License: GPL-3.0-only - https://spdx.org/licenses/GPL-3.0-only.html
---
 .../chrome/browser/ChromeTabbedActivity.java  | 40 +++++++-
 .../chrome/browser/app/ChromeActivity.java    | 28 ++++--
 .../customtabs/BaseCustomTabActivity.java     |  2 +-
 .../BaseCustomTabRootUiCoordinator.java       |  4 +-
 .../CustomTabIntentDataProvider.java          |  3 +
 .../tabbed_mode/TabbedRootUiCoordinator.java  |  3 +-
 .../browser/tabmodel/TabModelJniBridge.java   |  4 +-
 .../tabmodel/TabModelSelectorBase.java        |  7 ++
 .../browser/toolbar/ToolbarManager.java       |  4 +-
 .../chrome/browser/ui/RootUiCoordinator.java  |  6 +-
 .../developer_private_functions.cc            |  3 +-
 .../browser/extensions/extension_tab_util.cc  |  2 +-
 .../tabmodel/IncognitoTabModelImpl.java       | 10 +-
 .../tabmodel/IncognitoTabModelObserver.java   |  2 +
 .../extensions/extension_actions_bridge.cc    | 12 +++
 .../extensions/extension_actions_bridge.h     |  1 +
 .../ui/extensions/ExtensionActionsBridge.java |  6 ++
 .../android/tab_model/tab_model_jni_bridge.cc |  4 +
 .../ExtensionActionListCoordinator.java       |  4 +-
 .../ExtensionActionListMediator.java          | 19 +++-
 .../ExtensionToolbarCoordinator.java          |  7 +-
 .../ExtensionToolbarCoordinatorImpl.java      |  5 +-
 .../extensions/ExtensionsMenuCoordinator.java |  4 +-
 .../extensions/ExtensionsMenuMediator.java    | 10 +-
 .../ChromeAndroidTaskTrackerImpl.java         | 92 ++++++++++++++-----
 .../ChromeAndroidTaskTracker.java             |  7 +-
 26 files changed, 233 insertions(+), 56 deletions(-)

diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
@@ -118,6 +118,7 @@ import org.chromium.chrome.browser.compositor.overlays.strip.StripLayoutHelperMa
 import org.chromium.chrome.browser.compositor.overlays.strip.StripLayoutHelperManager.TabModelStartupInfo;
 import org.chromium.chrome.browser.cookies.CookiesFetcher;
 import org.chromium.chrome.browser.crypto.CipherFactory;
+import org.chromium.chrome.browser.customtabs.CustomTabActivity;
 import org.chromium.chrome.browser.data_sharing.DataSharingIntentUtils;
 import org.chromium.chrome.browser.data_sharing.DataSharingTabGroupUtils;
 import org.chromium.chrome.browser.data_sharing.DataSharingTabManager;
@@ -300,11 +301,13 @@ import org.chromium.chrome.browser.tasks.tab_management.TabSwitcherPaneBase;
 import org.chromium.chrome.browser.tasks.tab_management.TabUiUtils;
 import org.chromium.chrome.browser.tasks.tab_management.TabsSettings;
 import org.chromium.chrome.browser.tasks.tab_management.archived_tabs_auto_delete_promo.ArchivedTabsAutoDeletePromoManager;
+import org.chromium.chrome.browser.tabmodel.IncognitoTabModelObserver;
 import org.chromium.chrome.browser.toolbar.ToolbarIntentMetadata;
 import org.chromium.chrome.browser.toolbar.ToolbarManager;
 import org.chromium.chrome.browser.toolbar.extensions.ExtensionToolbarCoordinator;
 import org.chromium.chrome.browser.toolbar.top.ToolbarControlContainer;
 import org.chromium.chrome.browser.ui.AppLaunchDrawBlocker;
+import org.chromium.chrome.browser.ui.extensions.ExtensionActionsBridge;
 import org.chromium.chrome.browser.ui.IncognitoRestoreAppLaunchDrawBlockerFactory;
 import org.chromium.chrome.browser.ui.RootUiCoordinator;
 import org.chromium.chrome.browser.ui.appmenu.AppMenuPropertiesDelegate;
@@ -822,7 +825,36 @@ public class ChromeTabbedActivity extends ChromeActivity implements PreAttachInt
             mTabModelNotificationDotManager.initWithNative(mTabModelSelector);
             TabModel currentTabModel = mTabModelSelector.getCurrentModel();
             initializeChromeAndroidTask(
-                    BrowserWindowType.NORMAL, currentTabModel, mMultiInstanceManager);
+                    BrowserWindowType.NORMAL, mTabModelSelector.getModel(false), mMultiInstanceManager);
+
+            ProfileManager.addObserver(
+                new ProfileManager.Observer() {
+                    @Override
+                    public void onProfileAdded(Profile profile) {}
+
+                    @Override
+                    public void onProfileDestroyed(Profile profile) {
+                        if (!profile.isOffTheRecord()) return;
+                        ExtensionActionsBridge.get(profile)
+                            .closeBackgroundHosts();
+                    }
+                });
+
+            mTabModelSelector.addIncognitoTabModelObserver(
+                new IncognitoTabModelObserver() {
+                    @Override
+                    public void wasFirstTabCreated() {
+                        initializeChromeAndroidTask(BrowserWindowType.NORMAL,
+                            mTabModelSelector.getModel(true),
+                            mMultiInstanceManager);
+                    }
+
+                    @Override
+                    public void didDestroyed() {
+                        destroyIncognitoAndroidTask(
+                            mTabModelSelector.getModel(true));
+                    }
+                });
 
             // For saving non-incognito tab closures for Recent Tabs.
             boolean alwaysIncognito = AlwaysIncognitoLinkInterceptor.isAlwaysIncognito();
@@ -2969,7 +3001,7 @@ public class ChromeTabbedActivity extends ChromeActivity implements PreAttachInt
                 mLayoutStateProviderSupplier,
                 getBrowserControlsManager(),
                 getWindowAndroid(),
-                getChromeAndroidTaskSupplier(),
+                (tab) -> getChromeAndroidTask(tab),
                 getLifecycleDispatcher(),
                 getLayoutManagerSupplier(),
                 /* menuOrKeyboardActionController= */ this,
@@ -3885,6 +3917,10 @@ public class ChromeTabbedActivity extends ChromeActivity implements PreAttachInt
             }
             RecordUserAction.record("MobileMenuRecentTabs");
         } else if (id == R.id.extensions_menu_id) {
+            if (getCurrentTabModel().isIncognito()) {
+                CustomTabActivity.showInfoPage(this, UrlConstants.CHROME_EXTENSIONS_URL);
+                return true;
+            }
             LoadUrlParams params =
                     new LoadUrlParams(
                             UrlConstants.CHROME_EXTENSIONS_URL, PageTransition.AUTO_TOPLEVEL);
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
@@ -458,7 +458,7 @@ public abstract class ChromeActivity extends AsyncInitializationActivity
 
     private @Nullable TabStateThemeResourceProvider mThemeResourceProvider;
 
-    private final OneshotSupplierImpl<ChromeAndroidTask> mChromeAndroidTaskSupplier =
+    private final OneshotSupplierImpl<ChromeAndroidTask> mChromeAndroidTaskSupplierInternal =
             new OneshotSupplierImpl<>();
 
     protected ChromeActivity() {
@@ -1121,13 +1121,29 @@ public abstract class ChromeActivity extends AsyncInitializationActivity
                     () -> ExtensionWindowControllerBridgeFactory.create(chromeAndroidTask));
 
             // 5. Make the ChromeAndroidTask available via OneshotSupplier.
-            mChromeAndroidTaskSupplier.set(chromeAndroidTask);
+            if (!currentTabModel.isIncognito())
+                mChromeAndroidTaskSupplierInternal.set(chromeAndroidTask);
+
+            onTopResumedActivityChangedWithNative(/* isTopResumedActivity= */ true);
         }
     }
 
     /** Returns an {@link OneshotSupplier} for {@link ChromeAndroidTask}. */
-    protected final OneshotSupplier<ChromeAndroidTask> getChromeAndroidTaskSupplier() {
-        return mChromeAndroidTaskSupplier;
+    protected final ChromeAndroidTask getChromeAndroidTask(Tab tab) {
+        TabModelSelector modelSelector = getTabModelSelector();
+        TabModel tabModel = modelSelector.getModelForTabId(tab.getId());
+        return ChromeAndroidTaskTrackerFactory.getInstance().get(
+            mChromeAndroidTaskSupplierInternal.get().getId(),
+            tabModel);
+    }
+
+    protected final void destroyIncognitoAndroidTask(TabModel tabModel) {
+        ChromeAndroidTask incognitoTask =
+            ChromeAndroidTaskTrackerFactory.getInstance().get(
+                mChromeAndroidTaskSupplierInternal.get().getId(),
+                tabModel);
+        ChromeAndroidTaskTrackerFactory.getInstance()
+            .onActivityWindowAndroidDestroy(incognitoTask);
     }
 
     @Override
@@ -2053,7 +2069,7 @@ public abstract class ChromeActivity extends AsyncInitializationActivity
 
         getProfileProviderSupplier().runSyncOrOnAvailable(this::initializeManualFillingComponent);
 
-        var chromeAndroidTask = getChromeAndroidTaskSupplier().get();
+        var chromeAndroidTask = mChromeAndroidTaskSupplierInternal.get();
         if (chromeAndroidTask != null) {
             chromeAndroidTask.onNativeInitializationFinished();
         }
@@ -2097,7 +2113,7 @@ public abstract class ChromeActivity extends AsyncInitializationActivity
                     && DeviceFormFactor.isNonMultiDisplayContextOnTablet(this)) {
                 HostZoomMap.setTransparentZoomAdjustment(
                         ContentFeatureList.sAndroidMonitorZoomScalingFactor.getValue() / 100.0f);
-            } else if (DeviceInfo.isDesktop()) {
+            } else if (DeviceInfo.isDesktopFalse()) {
                 HostZoomMap.setTransparentZoomAdjustment(
                         ContentFeatureList.sAndroidDesktopZoomScalingFactor.getValue() / 100.0f);
             }
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabActivity.java
@@ -392,7 +392,7 @@ public abstract class BaseCustomTabActivity extends ChromeActivity {
                         getTabModelSelectorSupplier(),
                         getBrowserControlsManager(),
                         getWindowAndroid(),
-                        getChromeAndroidTaskSupplier(),
+                        (tab) -> getChromeAndroidTask(tab),
                         getLifecycleDispatcher(),
                         getLayoutManagerSupplier(),
                         /* menuOrKeyboardActionController= */ this,
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabRootUiCoordinator.java b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabRootUiCoordinator.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabRootUiCoordinator.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/BaseCustomTabRootUiCoordinator.java
@@ -92,6 +92,7 @@ import org.chromium.chrome.browser.tab.EmptyTabObserver;
 import org.chromium.chrome.browser.tab.RequestDesktopUtils;
 import org.chromium.chrome.browser.tab.Tab;
 import org.chromium.chrome.browser.tab_ui.TabContentManager;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.TabCreatorManager;
 import org.chromium.chrome.browser.tabmodel.TabModelSelector;
 import org.chromium.chrome.browser.toolbar.adaptive.AdaptiveToolbarBehavior;
@@ -124,6 +125,7 @@ import org.chromium.ui.modaldialog.ModalDialogManager;
 
 import java.util.function.BooleanSupplier;
 import java.util.function.Supplier;
+import java.util.function.Function;
 
 /** A {@link RootUiCoordinator} variant that controls UI for {@link BaseCustomTabActivity}. */
 public class BaseCustomTabRootUiCoordinator extends RootUiCoordinator {
@@ -210,7 +212,7 @@ public class BaseCustomTabRootUiCoordinator extends RootUiCoordinator {
             @NonNull ObservableSupplier<TabModelSelector> tabModelSelectorSupplier,
             @NonNull BrowserControlsManager browserControlsManager,
             @NonNull ActivityWindowAndroid windowAndroid,
-            @NonNull OneshotSupplier<ChromeAndroidTask> chromeAndroidTaskSupplier,
+            @NonNull Function<Tab, ChromeAndroidTask> chromeAndroidTaskSupplier,
             @NonNull ActivityLifecycleDispatcher activityLifecycleDispatcher,
             @NonNull ObservableSupplier<LayoutManagerImpl> layoutManagerSupplier,
             @NonNull MenuOrKeyboardActionController menuOrKeyboardActionController,
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabIntentDataProvider.java b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabIntentDataProvider.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabIntentDataProvider.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabIntentDataProvider.java
@@ -341,6 +341,7 @@ public class CustomTabIntentDataProvider extends BrowserServicesIntentDataProvid
 
     private final boolean mEnableUrlBarHiding;
     private boolean mInteractWithBackground;
+    private boolean mIsExtension = false;
     private List<CustomButtonParams> mCustomButtonParams;
     private @Nullable Drawable mCloseButtonIcon;
     private final boolean mIsCloseButtonEnabled;
@@ -724,6 +725,7 @@ public class CustomTabIntentDataProvider extends BrowserServicesIntentDataProvid
         mSideSheetRoundedCornersPosition =
                 getActivitySideSheetRoundedCornersPositionFromIntent(intent);
 
+        mIsExtension = getUrlToLoad().startsWith(UrlConstants.CHROME_EXTENSIONS_URL);
         logCustomTabFeatures(intent, colorScheme);
         String packageName = getClientPackageNameFromSessionOrCallingActivity(mIntent, mSession);
         RecordHistogram.recordBooleanHistogram(
@@ -1367,6 +1369,7 @@ public class CustomTabIntentDataProvider extends BrowserServicesIntentDataProvid
 
     @Override
     public @CustomTabProfileType int getCustomTabMode() {
+        if (mIsExtension) return CustomTabProfileType.REGULAR;
         return AlwaysIncognitoLinkInterceptor.isAlwaysIncognito()
                 ? CustomTabProfileType.INCOGNITO
                 : (ChromeFeatureList.sMayLaunchurlUsesSeparateStoragePartition.isEnabled()
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedRootUiCoordinator.java b/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedRootUiCoordinator.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedRootUiCoordinator.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedRootUiCoordinator.java
@@ -185,6 +185,7 @@ import org.chromium.chrome.browser.toolbar.adaptive.AdaptiveToolbarBehavior;
 import org.chromium.chrome.browser.ui.RootUiCoordinator;
 import org.chromium.chrome.browser.ui.appmenu.AppMenuBlocker;
 import org.chromium.chrome.browser.ui.appmenu.AppMenuDelegate;
+import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask;
 import org.chromium.chrome.browser.ui.default_browser_promo.DefaultBrowserPromoUtils;
 import org.chromium.chrome.browser.ui.desktop_windowing.AppHeaderCoordinator;
 import org.chromium.chrome.browser.ui.desktop_windowing.AppHeaderUtils;
@@ -421,7 +422,7 @@ public class TabbedRootUiCoordinator extends RootUiCoordinator {
             @NonNull OneshotSupplier<LayoutStateProvider> layoutStateProviderOneshotSupplier,
             @NonNull BrowserControlsManager browserControlsManager,
             @NonNull ActivityWindowAndroid windowAndroid,
-            @NonNull OneshotSupplier chromeAndroidTaskSupplier,
+            @NonNull Function<Tab, ChromeAndroidTask> chromeAndroidTaskSupplier,
             @NonNull ActivityLifecycleDispatcher activityLifecycleDispatcher,
             @NonNull ObservableSupplier<LayoutManagerImpl> layoutManagerSupplier,
             @NonNull MenuOrKeyboardActionController menuOrKeyboardActionController,
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelJniBridge.java b/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelJniBridge.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelJniBridge.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelJniBridge.java
@@ -133,10 +133,10 @@ public abstract class TabModelJniBridge implements TabModelInternal {
     @Override
     public void associateWithBrowserWindow(long nativeAndroidBrowserWindow) {
         // Ensure this isn't set multiple times.
-        assert mNativeAndroidBrowserWindow == 0;
+        if (nativeAndroidBrowserWindow != 0) assert mNativeAndroidBrowserWindow == 0;
         mNativeAndroidBrowserWindow = nativeAndroidBrowserWindow;
 
-        assert nativeAndroidBrowserWindow != 0;
+        // assert nativeAndroidBrowserWindow != 0;
         TabModelJniBridgeJni.get()
                 .associateWithBrowserWindow(mNativeTabModelJniBridge, nativeAndroidBrowserWindow);
     }
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelSelectorBase.java b/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelSelectorBase.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelSelectorBase.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/tabmodel/TabModelSelectorBase.java
@@ -488,6 +488,13 @@ public abstract class TabModelSelectorBase
         }
     }
 
+    @Override
+    public void didDestroyed() {
+        for (IncognitoTabModelObserver observer : mIncognitoObservers) {
+            observer.didDestroyed();
+        }
+    }
+
     @Override
     public void didBecomeEmpty() {
         for (IncognitoTabModelObserver observer : mIncognitoObservers) {
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/toolbar/ToolbarManager.java b/chrome/android/java/src/org/chromium/chrome/browser/toolbar/ToolbarManager.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/toolbar/ToolbarManager.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/toolbar/ToolbarManager.java
@@ -141,6 +141,7 @@ import org.chromium.chrome.browser.tab.TabObscuringHandler;
 import org.chromium.chrome.browser.tab.TabSelectionType;
 import org.chromium.chrome.browser.tab_ui.TabContentManager;
 import org.chromium.chrome.browser.tab_ui.TabModelDotInfo;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.IncognitoStateProvider;
 import org.chromium.chrome.browser.tabmodel.TabCreatorManager;
 import org.chromium.chrome.browser.tabmodel.TabModel;
@@ -241,6 +242,7 @@ import org.chromium.url.GURL;
 
 import java.util.List;
 import java.util.function.Supplier;
+import java.util.function.Function;
 
 import org.chromium.chrome.browser.flags.ChromeFeatureList;
 import android.view.Gravity;
@@ -802,7 +804,7 @@ public class ToolbarManager
             ObservableSupplier<Boolean> omniboxFocusStateSupplier,
             OneshotSupplier<Boolean> promoShownOneshotSupplier,
             WindowAndroid windowAndroid,
-            OneshotSupplier<ChromeAndroidTask> chromeAndroidTaskSupplier,
+            Function<Tab, ChromeAndroidTask> chromeAndroidTaskSupplier,
             Supplier<Boolean> isInOverviewModeSupplier,
             Supplier<ModalDialogManager> modalDialogManagerSupplier,
             StatusBarColorController statusBarColorController,
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ui/RootUiCoordinator.java b/chrome/android/java/src/org/chromium/chrome/browser/ui/RootUiCoordinator.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/ui/RootUiCoordinator.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ui/RootUiCoordinator.java
@@ -149,6 +149,7 @@ import org.chromium.chrome.browser.tab.TabSelectionType;
 import org.chromium.chrome.browser.tab_ui.RecyclerViewPosition;
 import org.chromium.chrome.browser.tab_ui.TabContentManager;
 import org.chromium.chrome.browser.tab_ui.TabSwitcher;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.TabCreator;
 import org.chromium.chrome.browser.tabmodel.TabCreatorManager;
 import org.chromium.chrome.browser.tabmodel.TabModel;
@@ -243,6 +244,7 @@ import org.chromium.url.GURL;
 import java.lang.ref.WeakReference;
 import java.util.function.BooleanSupplier;
 import java.util.function.Supplier;
+import java.util.function.Function;
 
 /**
  * The root UI coordinator. This class will eventually be responsible for inflating and managing
@@ -276,7 +278,7 @@ public class RootUiCoordinator
     protected @Nullable AppMenuCoordinator mAppMenuCoordinator;
     private final MenuOrKeyboardActionController mMenuOrKeyboardActionController;
     protected final ActivityWindowAndroid mWindowAndroid;
-    private final OneshotSupplier<ChromeAndroidTask> mChromeAndroidTaskSupplier;
+    private final Function<Tab, ChromeAndroidTask> mChromeAndroidTaskSupplier;
 
     protected final ActivityTabProvider mActivityTabProvider;
     protected ObservableSupplier<ShareDelegate> mShareDelegateSupplier;
@@ -468,7 +470,7 @@ public class RootUiCoordinator
             @NonNull OneshotSupplier<LayoutStateProvider> layoutStateProviderOneshotSupplier,
             @NonNull BrowserControlsManager browserControlsManager,
             @NonNull ActivityWindowAndroid windowAndroid,
-            @NonNull OneshotSupplier<ChromeAndroidTask> chromeAndroidTaskSupplier,
+            @NonNull Function<Tab, ChromeAndroidTask> chromeAndroidTaskSupplier,
             @NonNull ActivityLifecycleDispatcher activityLifecycleDispatcher,
             @NonNull ObservableSupplier<LayoutManagerImpl> layoutManagerSupplier,
             @NonNull MenuOrKeyboardActionController menuOrKeyboardActionController,
diff --git a/chrome/browser/extensions/api/developer_private/developer_private_functions.cc b/chrome/browser/extensions/api/developer_private/developer_private_functions.cc
--- a/chrome/browser/extensions/api/developer_private/developer_private_functions.cc
+++ b/chrome/browser/extensions/api/developer_private/developer_private_functions.cc
@@ -1746,7 +1746,8 @@ DeveloperPrivateDismissSafetyHubExtensionsMenuNotificationFunction::Run() {
   }
 
   Profile* profile = Profile::FromBrowserContext(browser_context());
-  SafetyHubMenuNotificationServiceFactory::GetForProfile(profile)
+  if (auto* menu_notification_service_factory = SafetyHubMenuNotificationServiceFactory::GetForProfile(profile))
+    menu_notification_service_factory
       ->DismissActiveNotificationOfModule(
           safety_hub::SafetyHubModuleType::EXTENSIONS);
   return RespondNow(NoArguments());
diff --git a/chrome/browser/extensions/extension_tab_util.cc b/chrome/browser/extensions/extension_tab_util.cc
--- a/chrome/browser/extensions/extension_tab_util.cc
+++ b/chrome/browser/extensions/extension_tab_util.cc
@@ -1256,7 +1256,7 @@ bool ExtensionTabUtil::OpenOptionsPageFromWebContents(
   if (!url) {
     return false;
   }
-  const bool open_in_tab = ShouldOpenInTab(extension);
+  const bool open_in_tab = false; //ShouldOpenInTab(extension);
 // Opens the url as instructed by `open_in_tab`. On android we take a different
 // path because the `Browser` object is not available.
 // TODO(crbug.com/441209530): Unify the path on android after browser
diff --git a/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelImpl.java b/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelImpl.java
--- a/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelImpl.java
+++ b/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelImpl.java
@@ -145,8 +145,12 @@ class IncognitoTabModelImpl implements IncognitoTabModelInternal {
             return;
         }
 
+        // Disassociate
+        mDelegateModel.associateWithBrowserWindow(/*nativeAndroidBrowserWindow=*/ 0);
+        mNativeAndroidBrowserWindow = 0;
+
         for (IncognitoTabModelObserver observer : mIncognitoObservers) {
-            observer.didBecomeEmpty();
+            observer.didDestroyed();
         }
 
         mDelegateModel
@@ -157,6 +161,10 @@ class IncognitoTabModelImpl implements IncognitoTabModelInternal {
         mCurrentTabSupplier.set(null);
         mTabCountSupplier.set(0);
 
+        for (IncognitoTabModelObserver observer : mIncognitoObservers) {
+            observer.didBecomeEmpty();
+        }
+
         mDelegateModel = EmptyTabModel.getInstance(true);
         for (Callback<TabModelInternal> delegateModelObserver : mDelegateModelObservers) {
             delegateModelObserver.onResult(mDelegateModel);
diff --git a/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelObserver.java b/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelObserver.java
--- a/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelObserver.java
+++ b/chrome/browser/tabmodel/android/java/src/org/chromium/chrome/browser/tabmodel/IncognitoTabModelObserver.java
@@ -33,4 +33,6 @@ public interface IncognitoTabModelObserver {
 
     /** Called when the last tab of the {@link IncognitoTabModel} is closed. */
     default void didBecomeEmpty() {}
+
+    default void didDestroyed() {}
 }
diff --git a/chrome/browser/ui/android/extensions/extension_actions_bridge.cc b/chrome/browser/ui/android/extensions/extension_actions_bridge.cc
--- a/chrome/browser/ui/android/extensions/extension_actions_bridge.cc
+++ b/chrome/browser/ui/android/extensions/extension_actions_bridge.cc
@@ -19,6 +19,8 @@
 #include "extensions/browser/extension_action.h"
 #include "extensions/browser/extension_action_manager.h"
 #include "extensions/browser/extension_registry.h"
+#include "extensions/browser/process_manager.h"
+#include "extensions/browser/process_manager_factory.h"
 #include "ui/color/color_provider_manager.h"
 #include "ui/events/android/key_event_android.h"
 #include "ui/events/event.h"
@@ -221,6 +223,16 @@ void ExtensionActionsBridge::ClearExtensionData(JNIEnv* env) {
         install_directory, install_updacked_directory));
 }
 
+void ExtensionActionsBridge::CloseBackgroundHosts(JNIEnv* env) {
+  extensions::ProcessManager* manager =
+          extensions::ProcessManagerFactory::GetForBrowserContextIfExists(profile_);
+  if (manager) {
+    manager->CloseBackgroundHosts();
+    ProcessManager::Get(profile_->GetOriginalProfile())
+            ->MaybeCreateStartupBackgroundHosts();
+  }
+}
+
 jni_zero::ScopedJavaLocalRef<jobject>
 ExtensionActionsBridge::HandleKeyDownEvent(
     JNIEnv* env,
diff --git a/chrome/browser/ui/android/extensions/extension_actions_bridge.h b/chrome/browser/ui/android/extensions/extension_actions_bridge.h
--- a/chrome/browser/ui/android/extensions/extension_actions_bridge.h
+++ b/chrome/browser/ui/android/extensions/extension_actions_bridge.h
@@ -53,6 +53,7 @@ class ExtensionActionsBridge : public ToolbarActionsModel::Observer {
       int tab_id,
       content::WebContents* web_contents);
   void ClearExtensionData(JNIEnv* env);
+  void CloseBackgroundHosts(JNIEnv* env);
   jni_zero::ScopedJavaLocalRef<jobject> HandleKeyDownEvent(
       JNIEnv* env,
       const ui::KeyEventAndroid& key_event);
diff --git a/chrome/browser/ui/android/extensions/java/src/org/chromium/chrome/browser/ui/extensions/ExtensionActionsBridge.java b/chrome/browser/ui/android/extensions/java/src/org/chromium/chrome/browser/ui/extensions/ExtensionActionsBridge.java
--- a/chrome/browser/ui/android/extensions/java/src/org/chromium/chrome/browser/ui/extensions/ExtensionActionsBridge.java
+++ b/chrome/browser/ui/android/extensions/java/src/org/chromium/chrome/browser/ui/extensions/ExtensionActionsBridge.java
@@ -245,6 +245,10 @@ public class ExtensionActionsBridge implements Destroyable {
         ExtensionActionsBridgeJni.get().clearExtensionData(mNativeExtensionActionsBridge);
     }
 
+    public void closeBackgroundHosts() {
+        ExtensionActionsBridgeJni.get().closeBackgroundHosts(mNativeExtensionActionsBridge);
+    }
+
     @NativeMethods
     public interface Natives {
         boolean extensionsEnabled(@JniType("Profile*") Profile profile);
@@ -281,6 +285,8 @@ public class ExtensionActionsBridge implements Destroyable {
 
         void clearExtensionData(long nativeExtensionActionsBridge);
 
+        void closeBackgroundHosts(long nativeExtensionActionsBridge);
+
         HandleKeyEventResult handleKeyDownEvent(
                 long nativeExtensionActionsBridge,
                 @JniType("ui::KeyEventAndroid") KeyEvent keyEvent);
diff --git a/chrome/browser/ui/android/tab_model/tab_model_jni_bridge.cc b/chrome/browser/ui/android/tab_model/tab_model_jni_bridge.cc
--- a/chrome/browser/ui/android/tab_model/tab_model_jni_bridge.cc
+++ b/chrome/browser/ui/android/tab_model/tab_model_jni_bridge.cc
@@ -126,6 +126,10 @@ void TabModelJniBridge::AssociateWithBrowserWindow(
 // BrowserWindowInterface is available on desktop Android, but not other Android
 // builds. For non-desktop Android, this function should be a no-op.
 #if BUILDFLAG(IS_DESKTOP_ANDROID_CROMITE)
+  if (native_android_browser_window == 0) {
+    scoped_unowned_user_data_.reset();
+    return;
+  }
   BrowserWindowInterface* android_browser_window =
       reinterpret_cast<BrowserWindowInterface*>(native_android_browser_window);
   CHECK(android_browser_window != nullptr);
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListCoordinator.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListCoordinator.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListCoordinator.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListCoordinator.java
@@ -21,6 +21,8 @@ import org.chromium.ui.listmenu.ListMenuButton;
 import org.chromium.ui.modelutil.MVCListAdapter.ModelList;
 import org.chromium.ui.modelutil.ViewGroupAdapter;
 
+import java.util.function.Function;
+
 /**
  * Root component for the extension action buttons. Exposes public API for external consumers to
  * interact with the buttons and affect their states.
@@ -37,7 +39,7 @@ public class ExtensionActionListCoordinator implements Destroyable {
             Context context,
             ExtensionActionListContainer container,
             WindowAndroid windowAndroid,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
             NullableObservableSupplier<Tab> currentTabSupplier) {
         mContainer = container;
 
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListMediator.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListMediator.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListMediator.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionActionListMediator.java
@@ -31,6 +31,8 @@ import org.chromium.ui.modelutil.MVCListAdapter.ListItem;
 import org.chromium.ui.modelutil.MVCListAdapter.ModelList;
 import org.chromium.ui.modelutil.PropertyModel;
 
+import java.util.function.Function;
+
 @NullMarked
 class ExtensionActionListMediator implements Destroyable {
     private static final String TAG = "EALMediator";
@@ -38,7 +40,7 @@ class ExtensionActionListMediator implements Destroyable {
     private final Context mContext;
     private final WindowAndroid mWindowAndroid;
     private final ModelList mModels;
-    private final ChromeAndroidTask mTask;
+    private final Function<Tab, ChromeAndroidTask> mTaskSupplier;
     private final ExtensionActionsUpdateHelper mExtensionActionsUpdateHelper;
 
     private final ActionsUpdateDelegate mActionsUpdateDelegate = new ActionsUpdateDelegate();
@@ -51,12 +53,12 @@ class ExtensionActionListMediator implements Destroyable {
             Context context,
             WindowAndroid windowAndroid,
             ModelList models,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
             NullableObservableSupplier<Tab> currentTabSupplier) {
         mContext = context;
         mWindowAndroid = windowAndroid;
         mModels = models;
-        mTask = task;
+        mTaskSupplier = task;
 
         mExtensionActionsUpdateHelper =
                 new ExtensionActionsUpdateHelper(
@@ -111,8 +113,13 @@ class ExtensionActionListMediator implements Destroyable {
         }
         int tabId = currentTab.getId();
 
+        ChromeAndroidTask task = mTaskSupplier.apply(currentTab);
+        if (task == null) {
+            return;
+        }
+
         ExtensionActionPopupContents contents =
-                ExtensionActionPopupContents.create(mTask, actionId, tabId);
+                ExtensionActionPopupContents.create(task, actionId, tabId);
         assert mCurrentPopup == null;
         mCurrentPopup =
                 new ExtensionActionPopup(mContext, mWindowAndroid, buttonView, actionId, contents);
@@ -131,9 +138,11 @@ class ExtensionActionListMediator implements Destroyable {
             return;
         }
 
+        ChromeAndroidTask task = mTaskSupplier.apply(currentTab);
+
         ExtensionActionContextMenuBridge bridge =
                 new ExtensionActionContextMenuBridge(
-                        mTask, actionId, webContents, ContextMenuSource.TOOLBAR_ACTION);
+                        task, actionId, webContents, ContextMenuSource.TOOLBAR_ACTION);
 
         ExtensionActionContextMenuUtils.showContextMenu(
                 mContext, buttonView, bridge, MenuBuilderHelper.getRectProvider(buttonView), null);
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinator.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinator.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinator.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinator.java
@@ -15,12 +15,15 @@ import org.chromium.build.annotations.Initializer;
 import org.chromium.build.annotations.NullMarked;
 import org.chromium.build.annotations.Nullable;
 import org.chromium.chrome.browser.tab.Tab;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.TabCreator;
 import org.chromium.chrome.browser.theme.ThemeColorProvider;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask;
 import org.chromium.chrome.browser.ui.extensions.ExtensionUi;
 import org.chromium.ui.base.WindowAndroid;
 
+import java.util.function.Function;
+
 /**
  * The coordinator of the extension-related toolbar UI.
  *
@@ -41,7 +44,7 @@ public interface ExtensionToolbarCoordinator extends Destroyable {
             Context context,
             ViewStub extensionToolbarStub,
             WindowAndroid windowAndroid,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
             NullableObservableSupplier<Tab> currentTabSupplier,
             TabCreator tabCreator,
             ThemeColorProvider themeColorProvider) {
@@ -77,7 +80,7 @@ public interface ExtensionToolbarCoordinator extends Destroyable {
             Context context,
             ViewStub extensionToolbarStub,
             WindowAndroid windowAndroid,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
             NullableObservableSupplier<Tab> currentTabSupplier,
             TabCreator tabCreator,
             ThemeColorProvider themeColorProvider);
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinatorImpl.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinatorImpl.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinatorImpl.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionToolbarCoordinatorImpl.java
@@ -16,6 +16,7 @@ import org.chromium.build.annotations.NullMarked;
 import org.chromium.build.annotations.Nullable;
 import org.chromium.build.annotations.ServiceImpl;
 import org.chromium.chrome.browser.tab.Tab;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.tabmodel.TabCreator;
 import org.chromium.chrome.browser.theme.ThemeColorProvider;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask;
@@ -24,6 +25,8 @@ import org.chromium.chrome.browser.ui.extensions.ExtensionUi;
 import org.chromium.chrome.browser.ui.extensions.R;
 import org.chromium.ui.base.WindowAndroid;
 
+import java.util.function.Function;
+
 /** The implementation of {@link ExtensionToolbarCoordinator}. */
 @NullMarked
 @ServiceImpl(ExtensionToolbarCoordinator.class)
@@ -39,7 +42,7 @@ public class ExtensionToolbarCoordinatorImpl implements ExtensionToolbarCoordina
             Context context,
             ViewStub extensionToolbarStub,
             WindowAndroid windowAndroid,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
             NullableObservableSupplier<Tab> currentTabSupplier,
             TabCreator tabCreator,
             ThemeColorProvider themeColorProvider) {
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuCoordinator.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuCoordinator.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuCoordinator.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuCoordinator.java
@@ -40,6 +40,8 @@ import org.chromium.ui.modelutil.PropertyModelChangeProcessor;
 import org.chromium.ui.modelutil.SimpleRecyclerViewAdapter;
 import org.chromium.ui.widget.RectProvider;
 
+import java.util.function.Function;
+
 /**
  * Coordinator for the extensions menu, accessed from the puzzle icon in the toolbar. This class is
  * responsible for the button and the menu.
@@ -75,7 +77,7 @@ public class ExtensionsMenuCoordinator implements Destroyable {
             Context context,
             ListMenuButton extensionsMenuButton,
             ThemeColorProvider themeColorProvider,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
             NullableObservableSupplier<Tab> currentTabSupplier,
             TabCreator tabCreator,
             ExtensionActionListCoordinator extensionActionListCoordinator) {
diff --git a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuMediator.java b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuMediator.java
--- a/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuMediator.java
+++ b/chrome/browser/ui/android/toolbar/java/src/org/chromium/chrome/browser/toolbar/extensions/ExtensionsMenuMediator.java
@@ -26,6 +26,8 @@ import org.chromium.ui.modelutil.MVCListAdapter.ModelList;
 import org.chromium.ui.modelutil.PropertyModel;
 import org.chromium.ui.widget.RectProvider;
 
+import java.util.function.Function;
+
 /**
  * Mediator for the extensions menu. This class is responsible for listening to changes in the
  * extensions and updating the model accordingly.
@@ -34,7 +36,7 @@ import org.chromium.ui.widget.RectProvider;
 class ExtensionsMenuMediator implements Destroyable {
     private final ActionsUpdateDelegate mActionsUpdateDelegate = new ActionsUpdateDelegate();
     private final Context mContext;
-    private final ChromeAndroidTask mTask;
+    private final Function<Tab, ChromeAndroidTask> mTask;
     private final Runnable mOnUpdateFinishedRunnable;
     private final ExtensionActionsUpdateHelper mExtensionActionsUpdateHelper;
     private final View mRootView;
@@ -42,7 +44,7 @@ class ExtensionsMenuMediator implements Destroyable {
 
     public ExtensionsMenuMediator(
             Context context,
-            ChromeAndroidTask task,
+            Function<Tab, ChromeAndroidTask> task,
             NullableObservableSupplier<Tab> currentTabSupplier,
             ModelList extensionModels,
             Runnable onUpdateFinishedRunnable,
@@ -99,9 +101,11 @@ class ExtensionsMenuMediator implements Destroyable {
             return;
         }
 
+        ChromeAndroidTask task = mTaskSupplier.get();
+
         ExtensionActionContextMenuBridge bridge =
                 new ExtensionActionContextMenuBridge(
-                        mTask, actionId, webContents, ContextMenuSource.MENU_ITEM);
+                        task, actionId, webContents, ContextMenuSource.MENU_ITEM);
 
         ExtensionActionContextMenuUtils.showContextMenu(
                 mContext,
diff --git a/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerImpl.java b/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerImpl.java
--- a/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerImpl.java
+++ b/chrome/browser/ui/browser_window/internal/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTrackerImpl.java
@@ -23,6 +23,7 @@ import org.chromium.build.annotations.Nullable;
 import org.chromium.chrome.browser.customtabs.PopupIntentCreatorProvider;
 import org.chromium.chrome.browser.incognito.IncognitoUtils;
 import org.chromium.chrome.browser.multiwindow.MultiInstanceManager;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask.PendingTaskInfo;
 import org.chromium.chrome.browser.util.WindowFeatures;
 import org.chromium.ui.base.ActivityWindowAndroid;
@@ -39,6 +40,30 @@ import java.util.Map;
 final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
     private static final String TAG = "CrAndroidTaskTracker";
 
+    private static class Key {
+        public final Integer mTaskId;
+        public final TabModel mTabModel;
+
+        public Key(Integer taskId, TabModel tabModel) {
+            mTaskId = taskId;
+            mTabModel = tabModel;
+        }
+
+        @Override
+        public boolean equals(Object obj) {
+            assert obj instanceof Key : "Wrong key.";
+
+            Key ref = (Key) obj;
+            return this.mTaskId.equals(ref.mTaskId)
+                   && this.mTabModel.equals(ref.mTabModel);
+        }
+
+        @Override
+        public int hashCode() {
+            return mTaskId.hashCode() ^ mTabModel.hashCode();
+        }
+    }
+
     private static @Nullable ChromeAndroidTaskTrackerImpl sInstance;
 
     private static boolean sPausePendingTaskActivityCreationForTesting;
@@ -56,7 +81,7 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
      * Maps {@link ChromeAndroidTask} IDs to their instances. This reflects the {@link
      * ChromeAndroidTask}'s ID when it is alive, and is different from its ID in the pending state.
      */
-    private final Map<Integer, ChromeAndroidTask> mTasks = new ArrayMap<>();
+    private final Map<Key, ChromeAndroidTask> mTasksCromite = new ArrayMap<>();
 
     /**
      * Maps pending {@link ChromeAndroidTask} IDs to their instances. This reflects the {@link
@@ -86,7 +111,8 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
         ThreadUtils.assertOnUiThread();
         int taskId = getTaskId(activityScopedObjects.mActivityWindowAndroid);
 
-        var existingTask = mTasks.get(taskId);
+        var key = new Key(taskId, activityScopedObjects.mTabModel);
+        var existingTask = mTasksCromite.get(key);
         if (existingTask != null) {
             assert existingTask.getBrowserWindowType() == browserWindowType
                     : "The browser window type of an existing task can't be changed.";
@@ -98,12 +124,12 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
             ChromeAndroidTask pendingTask = mPendingTasks.remove(pendingId);
             assert pendingTask != null : "Invalid pendingId provided.";
             pendingTask.addActivityScopedObjects(activityScopedObjects);
-            mTasks.put(taskId, pendingTask);
+            mTasksCromite.put(key, pendingTask);
             return pendingTask;
         }
 
         var newTask = new ChromeAndroidTaskImpl(browserWindowType, activityScopedObjects);
-        mTasks.put(taskId, newTask);
+        mTasksCromite.put(key, newTask);
         mObservers.forEach((observer) -> observer.onTaskAdded(newTask));
         return newTask;
     }
@@ -141,28 +167,43 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
 
     @Override
     @Nullable
-    public ChromeAndroidTask get(int taskId) {
+    public ChromeAndroidTask get(int taskId, TabModel tabModel) {
         ThreadUtils.assertOnUiThread();
-        return mTasks.get(taskId);
+        var key = new Key(taskId, tabModel);
+        return mTasksCromite.get(key);
     }
 
-    @Override
-    public void remove(int taskId) {
-        ThreadUtils.assertOnUiThread();
-        removeInternal(taskId);
-    }
+
+    // @Override
+    // public void remove(int taskId) {
+    //    ThreadUtils.assertOnUiThread();
+    //    removeInternal(taskId);
+    //    }
 
     @Override
     public void onActivityWindowAndroidDestroy(ActivityWindowAndroid activityWindowAndroid) {
         ThreadUtils.assertOnUiThread();
         int taskId = getTaskId(activityWindowAndroid);
-        var task = mTasks.get(taskId);
 
+        for (Key key : mTasksCromite.keySet()) {
+            if (key == null) continue;
+            if (key.mTaskId != taskId) continue;
+
+            var task = mTasksCromite.get(key);
+            if (task.getActivityWindowAndroid() != activityWindowAndroid) {
+                continue;
+            }
+            onActivityWindowAndroidDestroy(task, activityWindowAndroid);
+        }
+    }
+
+    @Override
+    public void onActivityWindowAndroidDestroy(ChromeAndroidTask task, ActivityWindowAndroid activityWindowAndroid) {
         if (task == null) {
             return;
         }
 
-        task.removeActivityScopedObjects(activityWindowAndroid);
+        task.removeActivityScopedObjects(activityWindowAndroid); <-- check this
 
         // Destroy the ChromeAndroidTask if there is no ActivityWindowAndroid associated with it.
         //
@@ -177,7 +218,7 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
         // In the future, we can register a Task listener when a ChromeAndroidTask is created,
         // then destroy it when notified of the Task removal.
         if (task.getTopActivityWindowAndroid() == null) {
-            removeInternal(taskId);
+            removeInternal(task); <-- check this
         }
     }
 
@@ -239,8 +280,8 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
      */
     void removeAllForTesting() {
         ThreadUtils.assertOnUiThread();
-        mTasks.forEach((taskId, task) -> task.destroy());
-        mTasks.clear();
+        mTasksCromite.forEach((taskId, task) -> task.destroy());
+        mTasksCromite.clear();
         mPendingTasks.forEach((taskId, task) -> task.destroy());
         mPendingTasks.clear();
     }
@@ -275,11 +316,17 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
                 pendingTaskInfo.mIntent, pendingTaskInfo.mCreateParams.getInitialBounds());
     }
 
-    private void removeInternal(int taskId) {
-        var taskRemoved = mTasks.remove(taskId);
+    private void removeInternal(ChromeAndroidTask taskRemoved) {
         if (taskRemoved != null) {
-            mObservers.forEach((observer) -> observer.onTaskRemoved(taskRemoved));
-            taskRemoved.destroy();
+            for (Key key : mTasksCromite.keySet()) {
+                if (key == null) continue;
+                if (mTasksCromite.get(key) == taskRemoved) {
+                    mTasksCromite.remove(key);
+
+                    mObservers.forEach((observer) -> observer.onTaskRemoved(taskRemoved));
+                    taskRemoved.destroy();
+                }
+            }
         }
     }
 
@@ -314,7 +361,8 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
         @BrowserWindowType int browserWindowType = createParams.getWindowType();
         switch (browserWindowType) {
             case BrowserWindowType.NORMAL:
-                for (ChromeAndroidTask task : mTasks.values()) {
+                List<ChromeAndroidTask> tasks = new ArrayList<>(mTasksCromite.values());
+                for (ChromeAndroidTask task : tasks) {
                     var intent = task.createIntentForNormalBrowserWindow(isIncognito);
                     if (intent != null) {
                         return intent;
@@ -360,7 +408,7 @@ final class ChromeAndroidTaskTrackerImpl implements ChromeAndroidTaskTracker {
 
     /** Returns all PENDING and ALIVE Tasks. */
     private List<ChromeAndroidTask> getAllTasks() {
-        List<ChromeAndroidTask> tasks = new ArrayList<>(mTasks.values());
+        List<ChromeAndroidTask> tasks = new ArrayList<>(mTasksCromite.values());
         tasks.addAll(mPendingTasks.values());
         return tasks;
     }
diff --git a/chrome/browser/ui/browser_window/public/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTracker.java b/chrome/browser/ui/browser_window/public/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTracker.java
--- a/chrome/browser/ui/browser_window/public/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTracker.java
+++ b/chrome/browser/ui/browser_window/public/android/java/src/org/chromium/chrome/browser/ui/browser_window/ChromeAndroidTaskTracker.java
@@ -8,6 +8,7 @@ import org.chromium.base.JniOnceCallback;
 import org.chromium.build.annotations.NullMarked;
 import org.chromium.build.annotations.Nullable;
 import org.chromium.chrome.browser.ui.browser_window.ChromeAndroidTask.ActivityScopedObjects;
+import org.chromium.chrome.browser.tabmodel.TabModel;
 import org.chromium.ui.base.ActivityWindowAndroid;
 
 /**
@@ -83,7 +84,7 @@ public interface ChromeAndroidTaskTracker {
      *
      * @param taskId Same as defined by {@link android.app.TaskInfo#taskId}.
      */
-    @Nullable ChromeAndroidTask get(int taskId);
+    @Nullable ChromeAndroidTask get(int taskId, TabModel tabModel);
 
     /**
      * Removes from the internal collection the {@link ChromeAndroidTask} with the given {@code
@@ -91,7 +92,7 @@ public interface ChromeAndroidTaskTracker {
      *
      * @param taskId Same as defined by {@link android.app.TaskInfo#taskId}.
      */
-    void remove(int taskId);
+    //void remove(int taskId);
 
     /**
      * Called when an {@link ActivityWindowAndroid} is destroyed.
@@ -100,6 +101,8 @@ public interface ChromeAndroidTaskTracker {
      */
     void onActivityWindowAndroidDestroy(ActivityWindowAndroid activityWindowAndroid);
 
+    void onActivityWindowAndroidDestroy(ChromeAndroidTask task);
+
     /**
      * Adds an observer which will be called on addition or removal of tasks.
      *
--
